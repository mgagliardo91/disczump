angular.module("underscore",[]).factory("_",["$window",function(e){return e._}]),angular.module("CryptoJS",[]).factory("$crypt",["$window",function(e){return e.CryptoJS}]),angular.module("disczump.services",["underscore","CryptoJS"]).factory("LocalStorage",[function(){var e=function(e,t){window.localStorage.setItem(e,t)},t=function(e){return window.localStorage.getItem(e)},r=function(e){window.localStorage.removeItem(e)},n=function(e){return null!=t(e)};return{addItem:e,getItem:t,removeItem:r,itemExists:n}}]).factory("Random",[function(){var e=function(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<e;n++)t+=r.charAt(Math.floor(Math.random()*r.length));return t};return{random:e}}]).factory("TempStore",["Random",function(e){var t={},r=function(r){var n=e.random(10);return t[n]=r,n},n=function(e,r){t[e]=r},o=function(e){return t[e]},i=function(e){return"undefined"!=typeof t[e]};return{setTemp:r,getTemp:o,setTempKey:n,hasKey:i}}]).factory("StartUp",["$q","AccountService","SocketUtils",function(e,t,r){var n=function(n){var o=e.defer();return t.initAccount(n).then(function(e){e&&r.init(),o.resolve(e)}),o.promise};return{init:n}}]).factory("FacebookUtils",["$window","$q","$ocLazyLoad","AccountService",function(e,t,r,n){var o,i="1456432391315141",a=function(){var e=t.defer();return"undefined"==typeof FB?r.load(["https://connect.facebook.net/en_US/sdk.js"]).then(function(){FB.init({appId:i,xfbml:!1,version:"v2.7"});try{FB.getLoginStatus(function(t){o=t,e.resolve()})}catch(t){e.resolve()}}):e.resolve(),e.promise},c=function(e){"connected"===o.status?e(!0,o):FB.login(function(t){return t.authResponse?(o=t,void e(!0,t)):e()},{scope:"email,user_photos",return_scopes:!0})},u=function(e,t){FB.api("/me?fields=first_name,last_name,email",function(r){t(!0,{token:e.authResponse,account:r})})},s=function(e){return n.doFacebookUnlink(e)},f=function(e){c(function(t,r){return r.authResponse?n.doFacebookLink(r.authResponse,e):e()})},d=function(e){c(function(t,r){t?u(r,e):e()})},l=function(e){c(function(t,r){return r.authResponse?n.doFacebookLogin(r.authResponse,e):e()})},p=function(e,t){FB.api("/?id="+window.serverURL+e+"&scrape=true","post",{},function(e){return t("undefined"==typeof e.id)})},g=function(e){FB.ui({method:"share",href:window.serverURL+e},function(e){console.log(e)})};return{login:l,link:f,unlink:s,getFBAccount:d,initFacebook:a,shareFacebook:g,scrapePath:p}}]).factory("SocketUtils",["APIService","$rootScope","$timeout","_","AccountService",function(e,t,r,n,o){var i,a,c=0,u={},s=function(e){u[e.type]&&u[e.type].forEach(function(t){t(e.data)})},f=function(){i=io.connect("/",{forceNew:!0,reconnection:!1}),i.on("connect",function(){i.emit("initialize",a)}).on("notification",function(e){s(e)}).on("disconnect",function(){t.$emit("ErrorEvent",{data:"Disconnected from disc|zump. Reconnecting...",title:"Connection Error"}),r(d,1e3)}).on("connect_error",function(){c++,c<10&&r(d,1e3)})},d=function(){"undefined"==typeof i&&e.GetExt("/oauth","/socket",function(e,t){e&&(a=t,f())},o.getToken())},l=function(e,t){u[e]&&u[e].indexOf(t)==-1?u[e].push(t):u[e]=[t],console.log("Added listener for type ["+e+"]. Count: ["+u[e].length+"]")},p=function(e,t){u[e]&&(u[e]=n.without(u[e],t)),console.log("Removed listener for type ["+e+"]. Count: ["+u[e].length+"]")};return{init:d,registerForNotification:l,unregisterForNotification:p}}]).factory("PageCache",["$location","$rootScope",function(e,t){function r(e){s=e,d.push({path:e,data:{}})}function n(e){f=s===e,f&&d.length>2&&d.splice(d.length-2,2)}function o(){return f}function i(e,t){d.length&&(d[d.length-1].data[e]=t)}function a(e){d.length&&(d[d.length-1].data=e)}function c(){if(d.length)return d[d.length-1].data}function u(){t.$on("$locationChangeSuccess",function(){r(e.url())}),t.$watch(function(){return e.url()},function(e){n(e)})}var s,f,d=[];return{isNavBack:o,setDataItem:i,setData:a,init:u,getPageData:c}}]).factory("PageUtils",[function(){function e(){var e=document.body,t=document.documentElement;return Math.max(e.scrollHeight,e.offsetHeight,t.clientHeight,t.scrollHeight,t.offsetHeight)}function t(){var e=document.body,t=document.documentElement;return Math.max(e.scrollWidth,e.offsetWidth,t.clientWidth,t.scrollWidth,t.offsetWidth)}function r(){return window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop}function n(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function o(e){var t=e.getBoundingClientRect();return t.top+window.pageYOffset-document.documentElement.clientTop}function i(e){var t=e.getBoundingClientRect();return t.left+window.pageXOffset-document.documentElement.clientLeft}function a(e){return o(e)+e.offsetHeight}function c(){if(u)return u;var e,t=document.createElement("div"),r={transition:"transitionend",OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in r)if(r.hasOwnProperty(e)&&"undefined"!==t.style[e]){u=r[e];break}return u}var u;return{getDocHeight:e,getDocWidth:t,getWindowHeight:n,getScrollPos:r,getTop:o,getLeft:i,getFullHeight:a,getTransitionEndEventName:c}}]).factory("VerificationService",["APIService",function(e){function t(t){e.Post("/verify/pdga/reset",void 0,function(e,r){return e?t(!0,r):t(!1,r)})}function r(t,r,n){e.Post("/verify/pdga",{username:t,password:r},function(e,t){return e?n(!0,t):n(!1,t)})}return{verifyPDGA:r,resetPDGA:t}}]).factory("APIService",["$http","$window",function(e,t){function r(e){p=e}function n(e,t,r){var n=e+"?";for(var o in t)n=n+o+"="+t[o];return f({path:n,method:"GET",skipAuth:!0},r)}function o(e,t,r){return f({path:e,method:"GET",token:r},t)}function i(e,t,r,n){return f({path:t,method:"GET",root:e,token:n},r)}function a(e,t,r,n){return f({path:e,method:"PUT",data:t,token:n},r)}function c(e,t,r,n){return f({path:e,method:"POST",data:t,token:n},r)}function u(e,t,r,n,o){return f({path:t,method:"POST",data:r,root:e,token:o},n)}function s(e,t,r){return f({path:e,method:"DELETE",token:r},t)}function f(t,r){var n={Authorization:"Basic ZHpXZWI6JDJhJDA4JHNRRnVkSERCenYvNzNEbmVCbUVUYnVlR3E5dWxwRzNsUElLLjY4bVJJVVFUL3hqZFVIa1dX","If-Modified-Since":"Mon, 26 Jul 1997 05:00:00 GMT","Cache-Control":"no-cache",Pragma:"no-cache"};if(t.headers)for(var o in t.headers)n[o]=t.headers[o];return p&&(n.Authorization="Bearer "+p),t.token&&(n.Authorization="Bearer "+t.token),e({method:t.method,url:(t.root||"/api")+t.path,data:t.data,timeout:5e3,headers:n,timeout:15e3}).then(function(e){var t=l(e);if(r)return r(t.success,t.data)},function(e){if(r)return 403==e.status?r(!1,{message:"Invalid username or password.",type:"Login Failed"}):r(!1,d(e))})}function d(e){return e.data&&e.data.error?e.data.error:(console.log("unknown error: "+JSON.stringify(e)),{message:"Failed to hit server with request.",type:"Internal Error"})}function l(e){return e.data&&e.data.error?{sucess:!1,data:e.data.error}:{success:!0,data:e.data}}var p;return{Get:o,GetExt:i,Put:a,Post:c,PostExt:u,Delete:s,Query:n,setToken:r}}]).factory("LocationService",["$http",function(e){function t(e){return{address:e.formatted_address,latitude:e.geometry.location.lat,longitude:e.geometry.location.lng}}function r(e,r){var n={success:!1};return"OK"==e.data.status?(n.data=[],n.success=!0,e.data.results.forEach(function(e){if(r){for(var o=0;o<r.length;o++)if(e.types.indexOf(r[o])>-1){n.data.push(t(e));break}}else n.data.push(t(e))})):n.data={type:"Invalid Data Error",message:"The supplied address supplied no results."},n}function n(t,n,o,i){return!i&&d[String(t+","+n)]?o(!0,d[String(t+","+n)]):void e({method:"GET",headers:{"Content-type":"application/json"},url:s+"?latlng="+encodeURI(t+","+n),timeout:5e3}).then(function(e){console.log(e);var i=r(e,["postal_code"]);return i.success&&(d[String(t+","+n)]=i.data),o(i.success,i.data)},function(e){return o(!1,{message:"Failed to hit Google server with request.",type:"Internal Error"})})}function o(t,n,o){e({method:"GET",headers:{"Content-type":"application/json"},url:s+"?key=AIzaSyB7kWqjg0Yei5bPUhwmKmvLVk6Zugh_-Fw&result_type=locality&address="+encodeURI(t),timeout:5e3}).then(function(e){var t=r(e,o);return t.success&&t.data.forEach(function(e){d[String(e.latitude+","+e.longitude)]=[e]}),n(t.success,t.data)},function(e){return n(!1,{message:"Failed to hit Google server with request.",type:"Internal Error"})})}function i(){return"undefined"!=typeof u}function a(){return f}function c(e){"undefined"!=typeof u&&e(!0,u),a()||e(!1,{message:"Geolocation is not available.",type:"Geolocation Unavailable"}),navigator.geolocation.getCurrentPosition(function(t){console.log(t),u=t.coords,e(!0,u)},function(t){e(!1,t)})}var u,s="https://maps.googleapis.com/maps/api/geocode/json",f="geolocation"in navigator,d={};return{isGeoAvailable:a,isLocationAvailable:i,getLocation:c,getGeoLocation:o,getReverseGeo:n}}]).factory("QueryUserService",["_","APIService",function(e,t){function r(t){var r=[];return r=e.filter(t,function(t){return e.contains(f,t.name)}),e.each(r,function(e){e.text=d[e.name]}),r}function n(e){var t={search:"",filters:[]};if(e.q&&(t.search=e.q),e.s&&(t.sort=s.indexOf(e.s)>-1?e.s:void 0),e.d){var n=parseInt(e.d);l.indexOf(n)>-1&&(t.geo={distance:n})}if(e.loc&&/^(\-?\d+(\.\d+)?),(\-?\d+(\.\d+)?)$/.test(e.loc)){var o=e.loc.split(",");t.geo||(t.geo={}),t.geo.latitude=o[0],t.geo.longitude=o[1]}for(var i=0;e["f_"+i];){var a=e["f_"+i].split(/[\:\|]+/);if(a.length>1){var c=a.shift();t.filters.push({name:c,fields:a})}i++}return t.filters=r(t.filters),t}function o(e){var t="?";if(e.query&&""!==e.query&&(t+="q="+e.query),e.sort&&(t+=(t.length>1?"&":"")+"s="+e.sort),e.geo&&(e.geo.distance&&(t+=(t.length>1?"&":"")+"d="+e.geo.distance),e.locSet&&(t+=(t.length>1?"&":"")+"loc="+e.geo.latitude+","+e.geo.longitude)),e.filter)for(var r=0;r<e.filter.length;r++){t+=(t.length>1?"&":"")+"f_"+r+"="+e.filter[r].name+":";for(var n=0;n<e.filter[r].fields.length;n++)t+=(n>0?"|":"")+e.filter[r].fields[n]}return t}function i(e){e.query||(e.query="");var t={query:e.query,sort:e.sort};return e.start&&(t.start=e.start),e.limit&&(t.limit=e.limit),e.filter&&e.filter.length&&(t.filter=e.filter),e.geo&&(t.geo=e.geo,t.geo.filter="undefined"!=typeof e.geo.distance),console.log(JSON.stringify(t.geo)),t}function a(e,r){var n="/query/users",o=i(e);t.Post(n,o,function(e,t){if(e){console.log(t);var n=c(t);return n.error?r(!1,n.error):r(!0,n)}return r(!1,t)})}function c(e){var t={};return 0!==e.responseHeader.status?{error:"Error performing search: "+e.responseHeader.status}:t={results:e.response.docs,start:e.response.start,total:e.response.numFound,facets:u(e.facets)}}function u(e){var t={facebook:{text:"Facebook",prop:"facebook",filters:[]},pdga:{text:"PDGA",prop:"pdga",filters:[]}};for(var r in e)p[r]?p[r].count=e[r].count:t[r]&&(t[r].filters=e[r].buckets);return{statFilters:t,geoFacets:p}}var s=["rel","proximity"],f=["distance","pdga","facebook"],d={pdga:"PDGA",facebook:"Facebook"},l=[10,25,50,100,500],p={d_10:{val:10,count:0},d_25:{val:25,count:0},d_50:{val:50,count:0},d_100:{val:100,count:0},d_500:{val:500,count:0}};return{queryAll:a,getQueryString:o,parseUrlQuery:n}}]).factory("QueryService",["_","APIService",function(e,t){function r(e){return e&&"all"!=e}function n(t,n){var o=[];o=e.filter(t,function(t){return e.contains(y,t.name)}),e.each(o,function(e){e.text=w[e.name]});var i=e.findWhere(o,{name:"value"});if(i)if(r(n))for(var a=i.fields.length;a>=0;)d(i.fields[a])&&i.fields.length>1&&i.fields.splice(a,1),a--;else o=e.without(o,i);return o}function o(e){var t={search:"",filters:[]};e.q&&(t.search=e.q),e.s&&(t.sort=v.indexOf(e.s)>-1?e.s:void 0),e.v&&(t.visible="true"===e.v||"false"!==e.v&&void 0);for(var r=0;e["f_"+r];){var o=e["f_"+r].split(/[\:\|]+/);if(o.length>1){var i=o.shift();t.filters.push({name:i,fields:o})}r++}return e.mode&&e.mode.length&&(t.mode=m.indexOf(e.mode)>-1?e.mode:"all"),t.filters=n(t.filters,t.mode),t}function i(e){var t="?";if(e.query&&""!==e.query&&(t+="q="+encodeURIComponent(e.query)),e.sort&&(t+=(t.length>1?"&":"")+"s="+encodeURIComponent(e.sort)),e.marketplace){var r=e.marketplace.forSale?e.marketplace.forTrade?"all-market":"sale":e.marketplace.forTrade?"trade":"all";t+=(t.length>1?"&":"")+"mode="+r}if("undefined"!=typeof e.visible&&(t+=(t.length>1?"&":"")+"v="+e.visible.toString()),e.filter)for(var n=0;n<e.filter.length;n++){t+=(t.length>1?"&":"")+"f_"+n+"="+e.filter[n].name+":";for(var o=0;o<e.filter[n].fields.length;o++)t+=(o>0?"|":"")+encodeURIComponent(e.filter[n].fields[o])}return t}function a(e){e.query||(e.query="");var t={query:e.query,sort:e.sort};return e.filter&&e.filter.length&&(t.filter=e.filter),e.start&&(t.start=e.start),e.limit&&(t.limit=e.limit),e.group&&(t.group=e.group),e.valueRange&&(t.valueRange=g),e.marketplace&&(t.marketplace=e.marketplace),t.visible=e.visible,t}function c(e,r){var n="/query/discs",o=a(e);e.userId&&(n="/query/trunk"+(e.userId?"/"+e.userId:"")),t.Post(n,o,function(e,t){if(e){console.log(t);var n=s(t);return n.error?r(!1,n.error):r(!0,n)}return r(!1,t)})}function u(e,r){var n=a(e),o="/query/discs/facet";e.facet&&(n.facet={name:e.facet.name,limit:e.facet.limit,offset:e.facet.offset,query:e.facet.query}),n.userId=e.userId,t.Post(o,n,function(e,t){if(e){var n=s(t);return console.log(t),n.error?r(!1,n.error):r(!0,n)}return r(!1,t)})}function s(e){var t={};return 0!==e.responseHeader.status?{error:"Error performing search: "+e.responseHeader.status}:t=e.grouped?{results:f(e.grouped),facets:l(e.facets)}:{results:e.response.docs,start:e.response.start,total:e.response.numFound,facets:l(e.facets)}}function f(e){var t={};for(var r in e){for(var n=e[r].groups,o=0;o<n.length;o++)t[n[o].groupValue]=n[o].doclist.docs;break}return t}function d(t){return!e.contains(h,t)}function l(e){var t={brand:{text:"Brand",prop:"brand",filters:[]},name:{text:"Name",prop:"name",filters:[]},type:{text:"Type",prop:"type",filters:[]},tag:{text:"Tags",prop:"tag",filters:[]},material:{text:"Material",prop:"material",filters:[]},color:{text:"Color",prop:"color",filters:[]},weight:{text:"Weight",prop:"weight",filters:[]},condition:{text:"Condition",prop:"condition",filters:[]},speed:{text:"Speed",prop:"speed",filters:[]},glide:{text:"Glide",prop:"glide",filters:[]},turn:{text:"Turn",prop:"turn",filters:[]},fade:{text:"Fade",prop:"fade",filters:[]}},r={forSale:{text:"For Sale",prop:"forSale",filters:[]},forTrade:{text:"For Trade",prop:"forTrade",filters:[]}},n={value:{text:"Value",prop:"value",filters:[]}};for(var o in e)t[o]?t[o].filters=e[o].buckets:r[o]?r[o].filters=e[o].buckets:n[o]&&(n[o].filters=e[o].buckets,e[o].after&&(n[o].filters[n[o].filters.length-1].count+=e[o].after.count));return{dynFilters:t,statFilters:r,rangeFilters:n}}function p(e){if(e.primaryImage)for(var t in e)if(/^imageList\.\d+\._id$/.test(t)&&e[t]==e.primaryImage)return"/files/"+e[t.replace("_id","thumbnailId")];return"/static/img/dz_disc.png"}for(var g={start:0,end:40,gap:10},h=[],v=["rel","new","alpha","createDate","modDate"],m=["all-market","sale","trade","all"],y=["brand","name","type","tag","material","color","weight","condition","speed","glide","turn","fade","value"],w={brand:"Brand",name:"Name",type:"Type",tag:"Tags",material:"Material",color:"Color",weight:"Weight",condition:"Condition",speed:"Speed",glide:"Glide",turn:"Turn",fade:"Fade",value:"Value"},S=g.start;S<=g.end-g.gap;S+=g.gap)S>=g.end-g.gap?h.push("["+S+" TO *]"):h.push("["+S+" TO "+(S+g.gap)+"]");return{parseUrlQuery:o,getQueryString:i,queryAll:c,queryFacet:u,isCustomRange:d,getSolrPrimaryImage:p}}]).factory("RedirectService",["$location","AccountService",function(e,t){var r,n=function(t){r=t,e.path("redirect")},o=function(e){return/^\/trunk(\/)?$/.test(e)?t.isLoggedIn()?"trunk/"+t.getAccountId():"login":""},i=function(){if("undefined"==typeof r)return o(e.path());var t=r;return n(),t};return{getRedirectPath:i,setRedirect:n}}]).factory("MembershipService",["APIService",function(e){var t={msDelete:"basic",msVisibility:"basic",msTag:"entry",msMarketplace:"entry",msBump:"pro",msSelect:"pro"},r=function(e,r){if(!e||!r)return!1;switch(t[e]){case"basic":return!0;case"entry":return"entry"==r.toLowerCase()||"pro"==r.toLowerCase();case"pro":return"pro"==r.toLowerCase();default:return!1}},n=function(e,t){switch(e.toLowerCase()){case"basic":switch(t.toLowerCase()){case"entry":case"pro":return"no-profile"}break;case"entry":switch(t.toLowerCase()){case"basic":return"clear-profile";case"pro":return"upgrade-profile"}break;case"pro":switch(t.toLowerCase()){case"basic":return"clear-profile";case"entry":return"downgrade-profile"}}},o=function(e){if(!e)return"Freelancer";switch(e.toLowerCase()){case"basic":return"Freelancer";case"entry":return"Entrepreneur";case"pro":return"Chief Executive";default:return"Freelancer"}},i=function(e){if(!e)return"";switch(e.toLowerCase()){case"basic":return"0.00";case"entry":return"0.99";case"pro":return"5.99"}return""},a=function(t,r,n){e.PostExt("/membership","/create",{type:t,billing:r},n)},c=function(t,r){e.PostExt("/membership","/changePayment",{billing:t},r)},u=function(t,r){e.PostExt("/membership","/modify",{type:t},r)},s=function(t){e.PostExt("/membership","/cancel",{},t)},f=function(t,r){e.PostExt("/membership","/activate",{type:t},r)};return{hasPermission:r,getChangeType:n,getAccountName:o,getAccountCost:i,createHostedPage:a,createHostedPageAdj:c,modifyExisting:u,clearExisting:s,reactivate:f}}]).factory("AccountService",["$rootScope","$q","_","$crypt","APIService","CacheService","LocalStorage",function(e,t,r,n,o,i,a){function c(e){o.Post("/verify/pdga/reset",void 0,p(e))}function u(e,t,r){o.Post("/verify/pdga",{username:e,password:t},p(r))}var s,f,d=[],l=function(e){for(var t=0;t<d.length;t++)void 0!==typeof d[t]&&d[t](e)},p=function(e){return function(t,r){t?(s=r,i.pushUser(s),l("AccountUpdated"),e(t,s)):e(t,r)}},g=function(){return navigator.userAgent.split(" ")[0]},h=function(){f=void 0,s=void 0,a.removeItem("dz-token"),o.setToken(void 0)},v=function(){return f.access_token},m=function(e){f=e;var t=n.AES.encrypt(JSON.stringify(e),g());a.addItem("dz-token",t.toString()),o.setToken(v()),l("AccountLoggedIn")},y=function(e){o.PostExt("/oauth","/logout",{},function(t,r){h(),l("AccountLoggedOut"),e&&e()})},w=function(e){o.Delete("/account",e)},S=function(e,t){o.Post("/account/delete",{authorizationId:e},function(e,r){console.log(r),y(),t(e,r)})},b=function(e,t){o.PostExt("/oauth","/confirm",{authorizationId:e},function(e,r){console.log(r),e&&m(r),t(e,r)})},A=function(e){o.PostExt("/oauth","/facebook/unlink",{},p(e))},k=function(e,t){o.PostExt("/oauth","/facebook/link",e,p(t))},x=function(e,t){o.PostExt("/oauth","/facebook/login",e,function(e,r){console.log(r),e&&m(r),t(e,r)})},I=function(e){var r=t.defer();if("undefined"!=typeof s)return e?T(function(e,t){r.resolve(t)}):r.resolve(s),r.promise;var c=a.getItem("dz-token");if(null!=c){try{c=n.AES.decrypt(c.toString(),g()).toString(n.enc.Utf8),c=JSON.parse(c)}catch(e){return void y()}return o.Get("/account",function(e,t){e?(m(c),console.log("Using Token: "+f.access_token),s=t,i.pushUser(s)):y(),r.resolve(s)},c.access_token),r.promise}return r.resolve(s),r.promise},O=function(e,t,r){o.PostExt("/oauth","/token",{username:e,password:t,grant_type:"password"},function(e,t){console.log(t),e&&m(t),r(e,t)})},P=function(e,t){o.Put("/account",e,p(t))},_=function(e,t){o.Post("/account/image",e,p(t))},E=function(e){o.Delete("/account/image",p(e))},F=function(e){return o.Get("/account/notifications",e)},L=function(e,t){return o.Put("/account/notifications",e,t)},C=function(e,t){return o.Put("/account/verifications",e,p(t))},D=function(e){"undefined"!=typeof f&&(s=e,i.pushUser(s))},U=function(){return"undefined"!=typeof s},T=function(e){return e&&U()?void o.Get("/account",p(e)):s},q=function(){return s?s._id:void 0},G=function(e){return U()?o.Get("/account/market",e):e(!1,{type:"Unauthorized",message:"User not logged in."})},R=function(){if(U())return"undefined"!=typeof s.image?s.image:"/static/img/dz_profile.png"},W=function(){return s&&s._id},$=function(e){return s&&s._id==e},B=function(e){d.indexOf(e)==-1&&d.push(e)},z=function(e){var t=d.indexOf(e);t>-1&&d.splice(t,1)};return{isLoggedIn:U,hasAccountId:W,putAccount:P,putAccountImage:_,getNotifications:F,putNotifications:L,putVerifications:C,resetPDGA:c,verifyPDGA:u,deleteAccountImage:E,getAccount:T,getAccountId:q,getAccountMarket:G,getAccountImage:R,initAccount:I,updateAccount:D,doLogin:O,doAccountConfirm:b,doAccountDeleteConfirm:S,doAccountDelete:w,doFacebookLogin:x,doFacebookLink:k,doFacebookUnlink:A,doLogout:y,compareTo:$,getToken:v,addListener:B,removeListener:z}}]).factory("CacheService",["_","APIService",function(e,t){function r(t){l=e.filter(d,function(e){return e._id!=t._id}),l.push(t)}function n(t){d=e.filter(d,function(e){return e._id!=t._id}),d.push(t)}function o(e,t){return i(e,!1,t)}function i(r,n,o){var i=e.findWhere(d,{username:r});return i&&!n?o(!0,i):void t.Get("/users/username/"+r,function(t,r){return t?(n&&(d=e.filter(d,function(e){return e._id!=userId})),d.push(r),o(!0,r)):o(!1,r)})}function a(e,t){return u(e,!0,t)}function c(e,t){return u(e,!1,t)}function u(r,n,o){var i=e.findWhere(d,{_id:r});return i&&!n?o(!0,i):void t.Get("/users/"+r,function(t,i){return t?(n&&(d=e.filter(d,function(e){return e._id!=r})),d.push(i),o(!0,i)):o(!1,i)})}function s(e,t){return f(e,!1,t)}function f(r,n,o){var i=e.findWhere(l,{_id:r});return i&&!n?o(!0,i):void t.Get("/discs/"+r,function(t,i){return t?(n&&(l=e.filter(l,function(e){return e._id!=r})),l.push(i),o(!0,i)):o(!1,i)})}var d=[],l=[];return{getUser:c,reloadUser:a,getUserByUsername:o,pushUser:n,pushDisc:r,getDisc:s}}]).factory("DiscService",["$q","APIService","CacheService",function(e,t,r){function n(e,r){return t.Put("/discs/"+e._id,e,u(r))}function o(e,r){return t.Put("/discs/"+e+"/bump",{},u(r))}function i(e,r){return t.Post("/discs",e,u(r))}function a(e,r){return t.Delete("/discs/"+e._id,r)}function c(t,r){var n=[];t.forEach(function(t,r){var o=e.defer();a(t,function(e,t){e?o.resolve(t):o.reject(t)}),n.push(o.promise)}),e.all(n).then(function(e){r(!0,e)},function(e){r(!1,e)})}var u=function(e){return function(t,n){t?(r.pushDisc(n),e(t,n)):e(t,n)}};return{editDisc:n,bumpDisc:o,createDisc:i,deleteDisc:a,deleteDiscs:c}}]).factory("MessageService",["$location","AccountService","APIService","SocketUtils",function(e,t,r,n){function o(e){for(var t=0;t<l.length;t++)"undefined"!=typeof l[t]&&l[t](e)}function i(e,t){f.push({type:e,id:t})}function a(e){e.forEach(function(e){i(e.type,e.id)})}function c(){return f.splice(0,f.length)}function u(){r.Get("/threads/messageCount",function(e,t){e&&(s=t.totalUnread,o({messageCount:s}))})}var s,f=[],d=!1,l=[],p=function(t){var r=new RegExp("threadId="+t.threadId);r.test(e.url())||(s++,o({messageCount:s}))},g=function(e){l.indexOf(e)==-1&&l.push(e),"undefined"!=typeof s&&o({messageCount:s})},h=function(e){var t=l.indexOf(e);t>-1&&l.splice(t,1)};return t.addListener(function(e){"AccountLoggedIn"!=e||d?"AccountLoggedOut"==e&&(n.unregisterForNotification("MessageNotification",p),d=!1):(n.registerForNotification("MessageNotification",p),u(),d=!0)}),t.isLoggedIn()&&(n.registerForNotification("MessageNotification",p),u(),d=!0),{TypeDisc:"d",TypeUser:"t",setAttachment:i,setAttachments:a,getAttachments:c,reloadUnreadCount:u,addListener:g,removeListener:h}}]).factory("DataService",["$q","$rootScope","_","APIService",function(e,t,r,n){function o(r){var o=[],i=e.defer();o.push(i.promise),n.Get("/account",function(e,t){e?(angular.copy(t,S),E=!0,i.resolve()):i.reject({process:"Error loading account.",error:t})});var a=e.defer();o.push(a.promise),n.Get("/account/preferences",function(e,t){e?(angular.copy(t,b),a.resolve()):a.reject({process:"Error loading preferences.",error:t})});var c=e.defer();o.push(c.promise),n.Get("/discs",function(e,t){e?(angular.copy(t,A),c.resolve()):c.reject({process:"Error loading discs.",error:t})}),e.all(o).then(function(e){t.$emit("DZUserPrefsUpdated"),r&&r(!0)},function(e){console.log(e),r&&r(!1,e)})}function i(e,t){if(e){var n=r.findWhere(e.imageList,{_id:e.primaryImage});return n?siteUrl+"/files/"+(t?n.thumbnailId:n.fileId):siteUrl+"/static/logo/logo_small_faded.svg"}}function a(e){return"Distance Driver"==e.type?b.colorize.distance:"Fairway Driver"==e.type?b.colorize.fairway:"Mid-range"==e.type?b.colorize.mid:"Putt/Approach"==e.type?b.colorize.putter:"Mini"==e.type?b.colorize.mini:"#FFFFFF"}function c(e,t){var o=r.findWhere(A,{_id:e}),i=r.findWhere(O,{_id:e});return"undefined"!=typeof o?t(!0,{disc:o,user:S}):("undefined"!=typeof i&&n.Get("/users/"+i.userId,function(e,r){return e?t(!0,{disc:i,user:r}):t(!1,r)}),void n.Get("/discs/"+e,function(e,r){return e?void n.Get("/users/"+r.userId,function(e,n){return e?t(!0,{disc:r,user:n}):t(!1,n)}):t(!1,r)}))}function u(e,t){var o=r.findWhere(k,{_id:e});return"undefined"!=typeof o?s(o,t):void n.Get("/users/"+e,function(e,n){return e?(k=r.uniq(r.union(k,[n]),!1,r.property("_id")),s(n,t)):t(!1,n)})}function s(e,t){return"undefined"==typeof e?t():void n.Get("/users/"+e._id+"/preview",function(r,n){return r?t(!0,{user:e,preview:n}):t(!1,n)})}function f(e,t){n.Post("/discs",e,function(e,r){return e?(A.push(angular.copy(r)),t(!0,r._id)):t(!1,r)})}function d(e,t){n.Put("/discs/"+e._id,e,function(e,n){if(e){var o=r.findWhere(A,{_id:n._id});return p(o,n),t(!0,n._id)}t(!1,n)})}function l(e,t){n.Delete("/discs/"+e._id,function(e,n){if(e){var o=r.findIndex(A,function(e){return e._id==n._id});return A.splice(o,1),t(!0,n._id)}t(!1,n)})}function p(e,t){e.brand=t.brand,e.name=t.name,e.type=t.type,e.material=t.material,e.weight=t.weight,e.color=t.color,e.speed=t.speed,e.turn=t.turn,e.glide=t.bgliderand,e.fade=t.fade,e.notes=t.notes,e.condition=t.condition,e.visible=t.visible,e.tagList=t.tagList,e.imageList=t.imageList,e.primaryImage=t.primaryImage}function g(t,r){if(t==S._id)r(!0,{discs:A,user:S});else{var o=[],i=e.defer();o.push(i.promise),n.Get("/users/"+t,function(e,t){e?(P=t,i.resolve()):(P=void 0,i.reject({process:"Error loading user account.",error:t}))});var a=e.defer();o.push(a.promise),n.Get("/users/"+t+"/discs",function(e,t){e?(O=t,a.resolve()):(O=void 0,a.reject({process:"Error loading user account.",error:t}))}),e.all(o).then(function(){r(!0,{discs:O,user:P})}),function(e){r(!1,e)}}}function h(e){_=e}function v(){return _?O:A}function m(){return _}function y(e){return I=e,"undefined"!=typeof e&&e.trim().length?void n.Get("/users?q="+e.trim(),function(e,t){if(e){if(t.query!=I)return;k=r.uniq(r.union(k,t.results),!1,r.property("_id")),x.splice(0,x.length),t.results.forEach(function(e){x.push(e)},x)}}):void x.splice(0,x.length)}function w(){return E}var S={},b={},A=[],k=[],x=[],I="",O=void 0,P=void 0,_=!1,E=!1;return{initialize:o,discs:A,users:x,userQuery:I,account:S,userPrefs:b,getPrimaryImage:i,getColorize:a,getDisc:c,getPublicDiscs:g,setPublicState:h,updateDisc:d,createDisc:f,deleteDisc:l,getActiveDiscList:v,isPublic:m,getUser:u,queryUsers:y,isAuthenticated:w}}]).factory("SearchService",["_",function(e){function t(t,o){""==t&&(t="*");for(var i=0;i<n.length;i++){var a=o[n[i]];if("undefined"!=typeof a)if(e.isArray(a)){for(var c=0;c<a.length;c++)if(r(t,a[c]))return!0}else if(r(t,a))return!0}return!1}function r(e,t){try{var r=t.toString().toLowerCase();return r.indexOf(e.toLowerCase())>=0}catch(e){return!1}}var n=["brand","name","type","color","weight","material","tagList"],o="";return{lastQuery:o,search:t}}]).factory("AutoFillService",["_","APIService","DataService",function(e,t,r){function n(e){return c?e():void t.Get("/templates",function(t,r){t&&(a=r),c=!0,e()})}function o(t,n){if("undefined"==typeof n)return[];var o="tagList"==t?r.discs:a.concat(r.discs),c=i(o,t),u=e.filter(c,function(t){var r;return"undefined"!=typeof t&&(r=e.isNumber(t)?String(t):t,r.toLowerCase().indexOf(n.toLowerCase())>=0)});return e.sortBy(u,function(e){return e.toLowerCase()})}function i(t,r){var n=[];if(t.length&&e.isArray(t[0][r])){var o=e.pluck(t,r);e.each(o,function(e){n=n.concat(e)})}else n=e.pluck(t,r);return e.uniq(n)}var a=[],c=!1;return{initialize:n,getOptions:o}}]).factory("FilterService",["$window","_","DataService",function(e,t,r){function n(){var e=t.reduce(g,function(e,t){return e+t.filters.length},0);return e>0}function o(e){return t.findWhere(g,{property:e})}function i(e){for(var n=r.getActiveDiscList(),o=[],i=0;i<h.length;i++){var a=h[i];if(e==a)break;var c=t.findWhere(g,{property:a});o.push(c),n=l(n,o)}return p(e,n)}function a(){t.each(g,function(e){e.filters=[]}),h=[],v=void 0}function c(e,r){var n=t.findWhere(g,{property:e});n&&(n.filters.push(r),t.contains(h,e)||h.push(e)),v=void 0}function u(e,r){var n=t.findWhere(g,{property:e});n&&(n.filters=t.without(n.filters,r),n.filters.length||(h=t.without(h,e))),v=void 0}function s(e,r){var n=t.findWhere(g,{property:e});return!!n&&t.contains(n.filters,r)}function f(e){var r={};return e||(e=g),t.each(g,function(e){r[e.property]=e.filters}),r}function d(e){v||(v=f());for(var r in v)if(v[r].length>0)if(t.has(e,r)){if(t.isArray(e[r])){var n=!1;if(t.each(e[r],function(e){t.contains(v[r],String(e))&&(n=!0)}),!n)return!1}else if(!t.contains(v[r],String(e[r])))return!1}else if(!t.contains(v[r],"undefined"))return!1;return!0}function l(e,r){v=f(r);var n=t.filter(e,function(e){return d(e,v)});return n}function p(e,r){var n=[];if(r.length&&t.isArray(r[0][e])){var o=t.pluck(r,e);t.each(o,function(e){n=n.concat(e)})}else n=t.pluck(r,e);return t.uniq(n)}var g=[{property:"brand",text:"Brand",filters:[]},{property:"name",text:"Name",filters:[]},{property:"tagList",text:"Tags",filters:[]},{property:"type",text:"Type",filters:[]},{property:"material",text:"Material",filters:[]},{property:"weight",text:"Weight",filters:[]},{property:"color",text:"Color",filters:[]},{property:"speed",text:"Speed",filters:[]},{property:"glide",text:"Glide",filters:[]},{property:"turn",text:"Turn",filters:[]},{property:"fade",text:"Fade",filters:[]},{property:"condition",text:"Condition",filters:[]}],h=[],v=void 0;return{filterProps:g,getFilters:f,getFilterItem:o,getFilterOptions:i,clearFilters:a,setOption:c,clearOption:u,isOptionActive:s,executeFilter:l,filterObj:d,isFilterActive:n}}]).factory("SortService",["$window","$rootScope","_","DataService",function(e,t,r,n){function o(){r.each(l,function(e){e.sortOn=!1,e.sortOrder=-1}),r.each(n.userPrefs.defaultSort,function(e){i(e.property,e.sortAsc)})}function i(e,t){var n=r.max(r.pluck(l,"sortOrder"))+1,o=r.findWhere(l,{property:e});o&&(o.sortOn=!0,o.sortAsc=t,o.sortOrder=n)}function a(e){var t=r.findWhere(l,{property:e}),n=r.where(l,{sortOn:!0}).length;if(t&&n>1){var o=t.sortOrder;t.sortOn=!1,t.sortOrder=-1,r.each(l,function(e){e.sortOn&&e.sortOrder>=o&&(e.sortOrder-=1)})}}function c(e,t,n){var o=r.findWhere(l,{property:e});r.each(l,function(e){e.sortOn&&e.sortOrder>=n&&e.sortOrder<t&&(e.sortOrder+=1)}),o.sortOrder=n}function u(){var e=[],t=r.sortBy(r.where(l,{sortOn:!0}),"sortOrder");return r.each(t,function(t){e.push((t.sortAsc?"+":"-")+t.property)}),e.toString()}function s(e){var t=r.sortBy(r.where(l,{sortOn:!0}),"sortOrder");return t.length?f(e,t,0):e}function f(e,t,n){if(n==t.length)return e=d(t[n-1],e);var o=t[n];if(0==n)return e=d(o,f(e,t,n+1));var i=t[n-1],a=r.groupBy(e,function(e){return e[i.property]}),c=[];return r.each(a,function(e){e=d(o,f(e,t,n+1)),c=c.concat(e)}),e=c}function d(e,t){return t="number"==e.type?r.sortBy(t,function(t){return parseInt(t[e.property])}):"date"==e.type?r.sortBy(t,function(t){return new Date(t[e.property])}):r.sortBy(t,function(t){return t[e.property]?t[e.property].toLowerCase():void 0}),e.sortAsc||(t=t.reverse()),t}var l=[{property:"brand",text:"Brand",sortOn:!0,sortAsc:!1,sortOrder:0,type:"text"},{property:"name",text:"Name",sortOn:!0,sortAsc:!1,sortOrder:1,type:"text"},{property:"type",text:"Type",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"text"},{property:"material",text:"Material",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"text"},{property:"weight",text:"Weight",sortOn:!1,sortAsc:!1,sortOrder:1,type:"number"},{property:"color",
text:"Color",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"text"},{property:"speed",text:"Speed",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"number"},{property:"glide",text:"Glide",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"number"},{property:"turn",text:"Turn",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"number"},{property:"fade",text:"Fade",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"number"},{property:"condition",text:"Condition",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"number"},{property:"createDate",text:"Create Date",sortOn:!1,sortAsc:!1,sortOrder:-1,type:"date"}];return t.$on("DZUserPrefsUpdated",function(){o()}),{sortItems:l,addSortItem:i,updateSortOrder:c,clearSort:a,getSortString:u,executeSort:s,setUserPrefs:o}}]).factory("ImageService",function(){var e=function(e){var t,r,n,o,i,a,c,u,s,f;for(c=e.naturalWidth,a=e.naturalHeight,r=document.createElement("canvas"),r.width=1,r.height=a,n=r.getContext("2d"),n.drawImage(e,0,0),o=n.getImageData(0,0,1,a).data,f=0,i=a,u=a;u>f;)t=o[4*(u-1)+3],0===t?i=u:f=u,u=i+f>>1;return s=u/a,0===s?1:s},t=function(t,r,n,o,i,a,c,u,s,f,d){var l,p,g;return l=e(n),d/=l,p=90==Math.abs(t)?u+d/2:u+f/2,g=90==Math.abs(t)?s+f/2:s+d/2,r.translate(p,g),r.rotate(-1*t*Math.PI/180),u=-f/2,s=-d/2,r.drawImage(n,o,i,a,c,u,s,f,d)},r=function(e,r){var n;n=new FileReader,n.onload=function(){var o;o=document.createElement("img"),o.onload=function(){var n=0;EXIF.getData(o,function(){switch(parseInt(EXIF.getTag(this,"Orientation"))){case 3:n=180;break;case 6:n=-90;break;case 8:n=90}var i,a,c,u,s;e.width=o.naturalWidth,e.height=o.naturalHeight,u=e.width,s=e.height,i=document.createElement("canvas"),a=i.getContext("2d"),i.width=90==Math.abs(n)?s:u,i.height=90==Math.abs(n)?u:s,t(n,a,o,0,0,o.width,o.height,0,0,u,s),c=i.toDataURL(e.type,.6),r(c)})},o.onerror=r,o.src=n.result},n.readAsDataURL(e)},n=function(e){for(var t=atob(e.split(",")[1]),r=new ArrayBuffer(t.length),n=new Uint8Array(r),o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new Blob([r],{type:"image/jpeg"})};return{getDataUri:r,dataURItoBlob:n}});