angular.module("disczump.controllers",["disczump.services"]).filter("startFrom",[function(){return function(e,t){return e?(t=+t,e.slice(t)):[]}}]).filter("cc",function(){return function(e){for(var t="",i=0;i<e.length;i++)i>0&&i%4==0&&(t+=" "),t+=e[i];return t}}).filter("exp",function(){return function(e){return 4==e.length?e.substr(0,2)+"/"+e.substr(2,2):e}}).filter("dateLocal",function(){return function(e){var t=new Date(e),i=t.getTime(),n=6e4*t.getTimezoneOffset();return new Date(i+n)}}).filter("memType",["MembershipService",function(e){return function(t){return e.getAccountName(t)}}]).filter("memCost",["MembershipService",function(e){return function(t){return e.getAccountCost(t)}}]).directive("dzMaxLength",function(){return{require:"ngModel",link:function(e,t,i,n){function a(e){if(e.length>r){var t=e.substring(0,r);return n.$setViewValue(t),n.$render(),t}return e}var r=parseInt(i.dzMaxLength);n.$parsers.push(a)}}}).directive("popContainer",["$timeout","$window","PageUtils",function(e,t,i){return{restrict:"A",scope:!0,link:function(e,t,n){var a={origTop:0},r=function(e){a.origTop=i.getTop(t[0]),e?t.css({position:"fixed",top:"0px"}):t.css({position:"relative",top:"auto"}),a.fixed=e},o=function(){var e=i.getScrollPos();!a.fixed&&e>=i.getTop(t[0])?r(!0):a.fixed&&e<a.origTop&&r(!1)};angular.element(document).bind("scroll",o),e.$on("destroy",function(){angular.element(document).unbind("scroll",o)})}}}]).directive("fadeTime",["$window","$timeout","$parse","PageUtils",function(e,t,i,n){return{restrict:"A",scope:!1,link:function(i,a,r){var o=Math.max(0,parseInt(r.fadeTime)),s=!1,c=n.getTransitionEndEventName();a.addClass("fade-time"),r.fadeReverse&&a.addClass("fade-reverse");var l=function(){r.fadeReverse&&a.css("display","none"),r.fadeComplete&&t(function(){i.fadeComplete=!0})},d=function(){s||(s=!0,a.addClass("expired"),c||t(l,750))},u=function(){t(d,o)},p=function(){n.getScrollPos()+n.getWindowHeight()>=n.getTop(a[0])&&(angular.element(e).unbind("scroll",p),u())};r.fadeOverride&&i.$watch(r.fadeOverride,function(e){"undefined"!=typeof e&&e&&d()}),c&&a[0].addEventListener(c,l,!1),i.$on("$destroy",function(){r.fadeScroll&&angular.element(e).unbind("scroll",p)}),r.fadeStart?i.$watch(r.fadeStart,function(e){"undefined"!=typeof e&&e&&u()}):r.fadeScroll?angular.element(e).bind("scroll",p):u()}}}]).directive("parallax",["$window","PageUtils",function(e,t){return{restrict:"A",transclude:!0,template:"<div ng-transclude></div>",scope:{parallaxRatio:"@",parallaxVerticalOffset:"@"},link:function(i,n,a){var r=function(){var a=(t.getTop(n[0])-e.pageYOffset)*(i.parallaxRatio?i.parallaxRatio:1.1)-(i.parallaxVerticalOffset||0);n.css("background-position","50% "+a+"px")},o=function(){r(),i.$apply()};angular.element(e).bind("load",o),angular.element(e).bind("scroll",r),angular.element(e).bind("touchmove",r),i.$on("$destroy",function(){angular.element(e).unbind("load",o),angular.element(e).unbind("scroll",r),angular.element(e).unbind("touchmove",r)})}}}]).directive("filterDropdown",["$window","$compile","$location","AccountService","PageUtils","CacheService",function($window,$compile,$location,AccountService,PageUtils,CacheService){return{restrict:"A",scope:{user:"="},link:function(scope,element,attrs){var opts,dropdown,backdrop,buffer=5,hideGlobal="true"===attrs.trunkOnly,relocateDropdown=function(){dropdown&&dropdown.css({top:PageUtils.getFullHeight(element[0])+buffer+"px",left:PageUtils.getLeft(element[0])+"px"})},hideFilter=function(e){if(backdrop){if(e){if(e.target!=backdrop[0])return;e.stopPropagation()}backdrop[0].parentNode.removeChild(backdrop[0]),backdrop=void 0,dropdown=void 0,angular.element($window).unbind("resize",relocateDropdown)}};scope.hideFilter=function(e){hideFilter(e)},scope.doFilter=function(e,t){var i=opts.prop+":"+opts.val;if(hideFilter(),e)$location.url("/explore?s=rel&f_0="+i);else{var n=t||AccountService.getAccount().username;$location.url("/t/"+n+"?s=rel&f_0="+i)}};var handleClick=function(){var e=!scope.hasOwnProperty("user")||AccountService.compareTo(scope.user._id);backdrop=angular.element('<div class="full-backdrop" ng-click="hideFilter($event)"></div>'),dropdown=angular.element('<div class="filter-dropdown"><div class="filter-marker"></div><div class="filter-dd-title">'+(opts.text?opts.text:opts.prop)+": "+opts.val+(opts.suffix?opts.suffix:"")+"</div>"+(hideGlobal?"":'<div class="filter-dd-opt"><span class="hover-underline" ng-click="doFilter(true);"><span><i class="fa fa-filter"></i></span>Filter globally</span></div>')+(e?"":'<div class="filter-dd-opt hover-underline"><span class="hover-underline" ng-click="doFilter(false, user.username);"><span><i class="fa fa-filter"></i></span>Filter in '+scope.user.username+"'s trunk</span></div>")+(AccountService.isLoggedIn()?'<div class="filter-dd-opt hover-underline"><span class="hover-underline" ng-click="doFilter();"><span><i class="fa fa-filter"></i></span>Filter in my trunk</span></div>':"")+"</div>"),document.body.appendChild(backdrop[0]),backdrop[0].appendChild(dropdown[0]),$compile(backdrop)(scope),relocateDropdown(),angular.element($window).bind("resize",relocateDropdown)};try{opts=eval("("+attrs.filterDropdown+")")}catch(e){return void console.log("Invalid expression for filter dropdown.")}opts.prop&&opts.val&&(element.bind("click",handleClick),scope.$on("destroy",function(){element.unbind("click",handleClick),hideFilter()}))}}}]).directive("dynIframe",[function(){return{restrict:"E",scope:{config:"="},link:function(e,t){function i(){var i="<iframe ";for(var n in e.config.params)i+=n+'="'+e.config.params[n]+'" ';i+="></iframe>";var a=angular.element(i);t[0].appendChild(a[0])}e.$watch("config.create",function(e){e===!0&&i()})}}}]).directive("removeIf",[function(){return{restrict:"A",scope:{removeIf:"="},link:function(e,t){e.$watch("removeIf",function(e){"undefined"!=typeof e&&e&&t.remove()})}}}]).directive("backToTop",["PageUtils","smoothScroll","$timeout",function(e,t,i){return{restrict:"E",replace:!0,scope:!0,template:'<div class="back-top" ng-click="scrollTop()">Back to Top</div>',link:function(n,a,r){function o(){d=e.getTop(l);var t=e.getLeft(l),i=t+(l.clientWidth-100)/2;a.css({left:i+"px"})}function s(){e.getScrollPos()>d?c||(a.css({display:"block"}),c=!0):c&&(a.css({display:"none"}),c=!1)}var c=!1,l=a[0].parentElement,d=e.getTop(l);n.scrollTop=function(){var e={duration:200,easing:"easeInQuad"};t(l,e)},angular.element(document).bind("scroll",s),n.$watch(function(){return l.clientWidth},function(){o()}),n.$on("destroy",function(){angular.element(document).unbind("scroll",s)}),i(o)}}}]).directive("countdown",["$interval","$timeout",function(e,t){return{restrict:"A",scope:{secLeft:"=",counts:"=",done:"=",show:"="},link:function(i,n){var a,r=function(){void 0!==typeof i.secLeft&&(i.secLeft>0?(i.done=!1,i.counts={hours:("0"+parseInt(i.secLeft/3600)).slice(-3),minutes:("0"+parseInt(i.secLeft%3600/60)).slice(-2),seconds:("0"+parseInt(i.secLeft%3600%60%60)).slice(-2)},i.secLeft=i.secLeft-1):i.done=!0)};i.$watch("done",function(t){"undefined"!=typeof t&&(t?e.cancel(a):a=e(r,1e3))}),t(function(){i.show=!0},1e3),n.on("$destroy",function(){e.cancel(a)}),r()}}}]).directive("matchWidth",[function(){return{restrict:"A",link:function(e,t,i){var n=function(e){angular.element(t[0]).css({height:e+"px"})};e.$watch(function(){return t[0].offsetWidth},function(e){n(e)})}}}]).directive("overflowWrapper",[function(){return{restrict:"E",replace:!0,template:"<div ng-transclude></div>",transclude:!0,link:function(e,t,i){var n=function(e){var i=angular.element(t[0].children[0]);i.css({maxWidth:e+"px"})};e.$watch(function(){return t[0].clientWidth},function(e){n(e)})}}}]).directive("mustMatch",[function(){return{require:"ngModel",scope:{ov:"=mustMatch"},link:function(e,t,i,n){n.$validators.compareTo=function(t){return t==e.ov},e.$watch("ov",function(){n.$validate()})}}}]).directive("patternSet",function(){return{require:"ngModel",link:function(e,t,i,n){var a=new RegExp(i.patternSet);n.$parsers.unshift(function(e){return n.$setValidity("patternSet",a.test(e)),e&&e.length?e:void 0}),n.$formatters.unshift(function(e){return n.$setValidity("patternSet",a.test(e)),e&&e.length?e:void 0})}}}).directive("validIf",["$parse",function(e){return{require:"ngModel",link:function(t,i,n,a){t.$watch(function(){return e(n.validIf)(t.$parent)},function(e){a.$setValidity("validIf",e&&e.length)})}}}]).directive("focusOn",["$timeout",function(e){return{restrict:"A",scope:{trigger:"=focusOn"},link:function(t,i){t.$watch("trigger",function(t){t===!0&&e(function(){i[0].focus()},300)})}}}]).directive("keyScrollList",["$timeout",function(e){return{restrict:"A",scope:{keyScrollList:"=",selection:"=",onSelect:"=",triggerFocus:"="},link:function(t,i){var n=function(i){switch(i.keyCode){case 9:t.selection>-1&&e(function(){t.onSelect(t.selection)});break;case 13:e(function(){t.selection>-1&&t.onSelect(t.selection)});break;case 38:e(function(){t.selection=Math.max(-1,t.selection-1)});break;case 40:e(function(){t.selection=Math.min(t.keyScrollList.length-1,t.selection+1)})}};i.bind("keydown",n),t.$watch("triggerFocus",function(t){t===!0&&e(function(){i[0].focus()},300)}),t.$on("$destroy",function(){i.unbind("keyup",n)})}}}]).directive("scrollMe",["$timeout",function(e){return{restrict:"A",scope:{scrollMe:"="},link:function(e,t){var i=t[0].parentElement;e.$watch("scrollMe",function(e){if("undefined"!=typeof e&&e===!0){var n=t[0].offsetTop+t[0].offsetHeight,a=i.scrollTop+i.offsetHeight;i.scrollTop>t[0].offsetTop?i.scrollTop=t[0].offsetTop:a<n&&(i.scrollTop=n-i.offsetHeight)}})}}}]).directive("parseInput",["$compile",function(e){return{restrict:"A",require:"ngModel",link:function(e,t,i,n){t.on("paste",function(){console.log("pasted")})}}}]).directive("locationSearch",["$window","$compile","$timeout","LocationService",function(e,t,i,n){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",locationSearch:"="},link:function(e,a,r,o){e.results=[],e.active=!1,e.init=!1,e.activeIndex=-1;var s,c,l=function(){s.css("width",a[0].clientWidth+"px")},d=function(t,i){n.getReverseGeo(t,i,function(t,i){t&&i.length&&e.locationSearch(i[0])},!0)};e.setLocation=function(e){d(e.latitude,e.longitude)};var u=function(){s=document.createElement("ul"),s.classList.add("location-result-container"),s.innerHTML='<li class="location-result handle-overflow" ng-repeat="result in results track by $index" ng-class="{\'active\':activeIndex == $index}" ng-click="$event.stopPropagation(); setLocation(result)" scroll-me="activeIndex == $index">{{result.address}}</li>',a[0].parentNode.insertBefore(s,a[0].nextSibling),s=angular.element(s),s.css("marginTop","7px"),s.attr("ng-show","results.length && active"),t(s)(e),l()},p=function(){n.getGeoLocation(o.$modelValue,function(t,i){t?(e.results=i,e.activeIndex=-1):e.results=[]},["postal_code"])},f=function(){c=!0,i(function(){e.active=!0})},g=function(){c=!1,i(function(){e.active=!1},200)},m=function(t){(13==t.keyCode||9==t.keyCode)&&e.activeIndex>-1&&t.preventDefault()},h=function(t){if((13==t.keyCode||9==t.keyCode)&&e.activeIndex>-1)return t.preventDefault(),t.stopImmediatePropagation(),e.setLocation(e.results[e.activeIndex]),void i(function(){e.activeIndex=-1,e.active=!1});switch(t.keyCode){case 38:t.stopImmediatePropagation(),i(function(){e.activeIndex=Math.max(-1,e.activeIndex-1)});break;case 40:t.stopImmediatePropagation(),i(function(){e.activeIndex=Math.min(e.results.length-1,e.activeIndex+1)})}};angular.element(window).bind("resize",l),a.bind("focus",f),a.bind("blur",g),a.bind("keyup",h),a.bind("keydown",m),e.$watch(function(){return o.$modelValue},function(t){"undefined"==typeof t||""==t?e.results=[]:(!e.active&&c&&(e.active=!0),p())}),e.$on("$destroy",function(){angular.element(window).unbind("resize",l),a.unbind("focus",f),a.unbind("blur",g),a.unbind("keyup",h),a.unbind("keydown",m)}),u()}}}]).directive("dzAutoComplete",["$compile","_","QueryService","$timeout",function(e,t,i,n){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",userId:"="},link:function(a,r,o,s){a.results=[],a.active=!1,a.init=!1,a.activeIndex=-1;var c,l,d=!1,u=!1,p=function(){l.css("width",r[0].clientWidth+"px"),l.css("marginTop",r[0].clientHeight+"px")},f=function(){l=document.createElement("ul"),l.classList.add("ac-container"),l.innerHTML='<li style="text-align:left;" ng-repeat="result in results track by $index" ng-class="{\'active\':activeIndex == $index}" ng-click="setInput(result.val)">{{result.val}} ({{result.count}})</li>',r[0].parentNode.insertBefore(l,r[0].nextSibling),l=angular.element(l),l.attr("ng-show","results.length && active"),e(l)(a),p()},g=function(e){return"undefined"!==s.$modelValue&&s.$modelValue.length?o.dzMulti?t.filter(e,function(e){return e.val.toLowerCase().indexOf(s.$modelValue.toLowerCase())>-1}):e:[]},m=function(){var e=s.$modelValue;i.queryFacet({query:s.$modelValue,userId:a.userId,facet:{name:o.dzAutoComplete,limit:20,offset:0,query:!0}},function(t,i){t&&(a.results=g(i.facets.dynFilters[o.dzAutoComplete].filters),c=e,a.activeIndex=-1)})};a.setInput=function(e){n(function(){a.ngModel=e,d=!0,r[0].focus()})};var h=function(){return u=!0,d?void(d=!1):(n(function(){a.active=!0}),void(c!=s.$modelValue&&s.$modelValue&&s.$modelValue.length&&m()))},v=function(){u=!1,n(function(){a.active=!1},100)},b=function(e){var t=13==e.keyCode&&a.activeIndex>-1||9==e.keyCode&&a.activeIndex>-1;t&&e.preventDefault()},y=function(e){var t=13==e.keyCode&&a.activeIndex>-1||9==e.keyCode&&a.activeIndex>-1;if(t)return e.preventDefault(),e.stopImmediatePropagation(),a.setInput(a.results[a.activeIndex].val),void n(function(){a.activeIndex=-1,a.active=!1});switch(e.keyCode){case 38:e.stopImmediatePropagation(),n(function(){a.activeIndex=Math.max(-1,a.activeIndex-1)});break;case 40:e.stopImmediatePropagation(),n(function(){a.activeIndex=Math.min(a.results.length-1,a.activeIndex+1)})}};angular.element(window).bind("resize",p),r.bind("focus",h),r.bind("blur",v),r.bind("keyup",y),r.bind("keydown",b),a.$watch(function(){return s.$modelValue},function(e){"undefined"==typeof e||""==e?a.results=[]:(!a.active&&u&&(a.active=!0),m())}),a.$on("$destroy",function(){angular.element(window).unbind("resize",p),r.unbind("focus",h),r.unbind("blur",v),r.unbind("keyup",y),r.unbind("keydown",b)}),f()}}}]).directive("parseText",["$compile","PageCache",function(e,t){return{restrict:"A",scope:{parseText:"="},link:function(i,n,a){var r=[],o="undefined"!=typeof i.parseText?i.parseText:"";n[0].innerHTML="";var s=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},c=function(e,t){for(var i=[],n=e.exec(t);null!=n;)i.push(n[0]),n=e.exec(t);return i};if("undefined"!=typeof a.parseDisc)for(var l=new RegExp("(?:https?://)?(?:www.)?(?:"+t.getUrlRegex()+"\\.com)/d/[a-zA-Z0-9-_]+","g"),d=c(l,o),u=0;u<d.length;u++){var p='<inline-disc disc-url="'+d[u]+'"></inline-disc>';r.push(p),o=o.split(d[u]).join("+_rep"+(r.length-1)+"+")}if("undefined"!=typeof a.parseUrl)for(var f=/(?:https?:\/\/)?(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,4}\b(?:[-a-zA-Z0-9@:%_\+.~#?&//=]*)/g,d=c(f,o),u=0;u<d.length;u++){var g=/^https?:\/\//i.test(d[u])?d[u]:"http://"+d[u];r.push('<a class="dz-blue hover-underline" href="'+g+'" target="_blank">'+d[u]+"</a>"),o=o.split(d[u]).join("+_rep"+(r.length-1)+"+")}o=s(o);for(var u=0;u<r.length;u++)o=o.split("+_rep"+u+"+").join(r[u]);for(var m="",h=o.split("\n"),u=0;u<h.length;u++)m+=h[u].length?/^(\<a|\<inline-disc)/g.test(h[u])?h[u]:"<span>"+h[u]+"</span>":"<br />";n[0].innerHTML='<div class="block-text">'+m+"</div>",e(angular.element(n[0].firstChild))(i.$parent)}}}]).directive("inlineDisc",["_","$timeout","CacheService","PageCache",function(e,t,i,n){return{restrict:"E",replace:!0,scope:{discUrl:"@"},template:'<a class="inline-disc hover-underline" ng-href="{{url}}"><img img-load directive-on="init" directive-set="{\'img-src\':\'{{image}}\'}"/>{{title}}</a>',link:function(a,r,o){var s=new RegExp("(?:https?://)?(?:www.)?(?:"+n.getUrlRegex()+"\\.com)/d/([a-zA-Z0-9-_]+)","g"),c=s.exec(a.discUrl);c?(a.discId=c[c.length-1],i.getDisc(a.discId,function(i,n){i?t(function(){a.image=n.primaryImage?"/files/"+e.findWhere(n.imageList,{_id:n.primaryImage}).fileId:void 0,a.init="undefined"!=typeof a.image,a.title=n.brand+" "+n.name,a.url="/d/"+n._id}):(a.title="Private Disc",a.url="#")})):a.title="Unknown Disc"}}}]).directive("dzHeader",["$window","$location","$timeout","PageUtils","AccountService","MessageService",function(e,t,i,n,a,r){return{restrict:"E",replace:!0,scope:{globalModalOpts:"=modalOpts"},template:'<div class="dz-navbar min-window-width" ng-class="{\'fixed\':fixed}" ng-style="{\'background-color\':\'rgba(74,74,74,\' + (alphaValue/100) +\')\'}"><div class="dz-navbar-btn-container float-left"><div class="dz-navbar-btn-list"><a href="/" ng-style="{\'opacity\': alphaValue}"><img src="/static/logo/logo_text.png" class="dz-navbar-logo"></a></div></div><div class="dz-navbar-btn-container float-right"><div class="dz-navbar-btn-list"><div class="dz-navbar-item dz-navbar-dropdown" ng-if="user" ng-click="toggleDropdown()"><div class="default-bg-image" img-load="/static/img/dz_profile.png" img-src="{{getAccountImage()}}" bg-image="true"></div><i class="fa fa-angle-double-down fa-lg" style="line-height:40px;"></i><div class="clearfix"></div></div><div class="backdrop" ng-show="showOptions" ng-click="toggleDropdown(false)" ng-if="user"></div><ul class="dz-dropdown-menu" ng-show="showOptions" ng-if="user"><li><a href="/d/create/templates"><span><i class="fa fa-tools fa-plus-circle"></i></span>Add Disc</a></li><li class="menu-sep"></li><li><a ng-click="showFeedbackModal()" id="menu-feedback" class="hover-pointer"><span><i class="fa fa-comment fa-tools"></i></span>Feedback</a></li><li><a href="/faq"><span><i class="fa fa-tools fa-question-circle"></i></span>FAQ</a></li><li><a href="/about"><span><i class="fa fa-tools fa-info-circle"></i></span>About</a></li><li class="menu-sep"></li><li><a href="/account"><span><i class="fa fa-tools fa-user"></i></span>My Account</a></li><li><a href="/logout" data-ajax="false"><span><i class="fa fa-sign-out fa-tools"></i></span>Logout</a></li></ul><div class="dz-navbar-links"><a class="dz-navbar-item dz-navbar-btn" href="/explore" ng-class="{\'active\':isItemActive(\'explore\')}">Explore</a><a class="dz-navbar-item dz-navbar-btn" href="/trunks" ng-class="{\'active\':isItemActive(\'trunks\')}">Trunks</a><a class="dz-navbar-item dz-navbar-btn" ng-if="!user" href="/about" ng-class="{\'active\':isItemActive(\'about\')}">About</a><a class="dz-navbar-item dz-navbar-btn" ng-if="user" ng-href="/t/{{user.username}}" ng-class="{\'active\':isItemActive(\'t/{{user.username}}\')}">My Trunk</a><a class="dz-navbar-item dz-navbar-btn" ng-if="user" ng-href="/inbox" ng-class="{\'active\':isItemActive(\'inbox\')}">Inbox<span ng-show="unreadCount > 0" style="color: #ffa840;"> ({{unreadCount}})</span></a><a class="dz-navbar-item dz-navbar-btn" href="/login" ng-if="!user" ng-class="{\'active\':isItemActive(\'login\')}">Sign In</a><a class="dz-navbar-item dz-navbar-btn" href="/signup" ng-if="!user" ng-class="{\'active\':isItemActive(\'signup\')}">Sign Up</a><div class="clearfix"></div></div></div></div><dz-modal modal-opts="globalModalOpts"></dz-modal><div class="clearfix"></div></div>',link:function(o,s,c){var l=new Audio("/static/audio/whoosh.wav");o.globalModalOpts={},o.user=a.getAccount(),o.showOptions=!1,o.unreadCount=void 0,o.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)};var d=function(){var t=n.getScrollPos(),i=e.innerHeight-50;o.safeApply(function(){o.alphaValue=Math.min(100,t/i*100)})};"true"===c.blend?(o.alphaValue=0,angular.element(document).bind("scroll",d)):o.alphaValue=100,"true"===c.fixed&&(o.fixed=!0),o.getAccountImage=function(){return o.user.image||"/static/img/dz_profile.png"},o.isItemActive=function(e){var i=new RegExp(e+"(\\?.*)?$");return i.test(t.url())},o.toggleDropdown=function(e){"undefined"!=typeof e?o.showOptions=e:o.showOptions=!o.showOptions},o.showFeedbackModal=function(){o.toggleDropdown(),o.globalModalOpts={type:"dz-feedback-modal",show:!0}};var u=function(e){i(function(){"undefined"!=typeof o.unreadCount&&e.messageCount>o.unreadCount&&l.play(),o.unreadCount=e.messageCount})};r.addListener(u),o.$on("$destroy",function(){angular.element(document).unbind("scroll",d),r.removeListener(u)})}}}]).directive("dzFooter",["$timeout","PageUtils",function(e,t){return{restrict:"E",replace:!0,template:'<div class="footer-bar" id="footer-bar" ng-show="footerReady"><div><span class="footer-copyright"><span class="cr-main">Copyright <i class="fa fa-copyright"></i> disc|zump, LLC</span><span class="cr-links"><a href="mailto:support@disczump.com">Contact Us</a><a href="/faq">FAQ</a><a href="/privacy">Privacy Policy</a><a href="/terms">Terms and Conditions</a></span></span><span class="footer-links"><a href="https://www.facebook.com/disczump/" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a><a href="https://twitter.com/disczump" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a><a href="https://instagram.com/disczump/" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-instagram fa-stack-1x fa-inverse"></i></span></a></span><div class="clearfix"></div></div></div>',link:function(t,i,n){e(function(){t.footerReady=!0},50)}}}]).directive("dzProfile",["$window","$timeout","CacheService","AccountService","$compile",function(e,t,i,n,a){return{restrict:"E",replace:!0,scope:{userId:"@",currentUser:"=",modalOpts:"="},template:'<div class="profile-container fclear"><div class="card-container" ng-show="loaded"><div id="card-remain" style="display: inline-block"><div class="profile-card p-info"><div class="p-info-img"><div class="default-bg-image" img-load="/static/img/dz_profile.png" directive-on="loaded" directive-set="{\'img-src\':\'{{getAccountImage()}}\'}" bg-image="true" ng-class="{\'has-img\':ready}"></div></div><div class="p-info-content p-container"><div class="p-info-icon"><span style="cursor:pointer;" class="fa-stack dz-blue-hover" modal-trigger="dz-profile-modal" data="{\'userId\':\'userId\'}" modal-opts="modalOpts"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-info fa-stack-1x fa-inverse"></i></span></div><div class="p-info-text"><div class="p-username handle-overflow">{{user.username}}</div><div class="p-name handle-overflow">{{user.firstName}} {{user.lastName}}</div></div><div class="p-info-bio fancy-scroll" ng-class="{\'has-ph\':!user.bio}"><span class="placeholder" ng-if="!user.bio">Hello, welcome to my trunk...</span><div parse-text="user.bio" parse-url parse-disc id="user-bio"></div></div></div></div><div class="profile-card p-icon-button" ng-if="currentUser != userId"><div class="p-container"><a class="p-icon-text align-vmid" ng-href="/inbox?userId={{user._id}}"><div class="p-icon-style"><i class="fa fa-envelope"></i></div><div class="p-icon-label">Message</div></a></div></div><div class="profile-card p-icon-button" ng-if="currentUser == userId"><div class="p-container"><a class="p-icon-text align-vmid" href="/d/create/templates"><div class="p-icon-style"><i class="fa fa-plus-circle"></i></div><div class="p-icon-label">Add Disc</div></a></div></div></div><div class="profile-card p-icon-button" ng-show="!cardLoaded"><div class="p-container"><div class="p-icon-text align-vmid"><div class="p-icon-style"><i class="fa fa-spin fa-spinner"></i></div></div></div></div><div ng-style="contStyle" class="card-list" id="card-list" ng-show="cardLoaded"></div></div><div class="explore-nav" ng-show="navArr.length > 1" ng-init="start = 0"><span><i class="fa fa-angle-double-left nav-list-arrow" ng-click="pageBack()" ng-class="{inactive: start == 0}"></i><i class="fa" ng-repeat="i in navArr track by $index" ng-click="navIndex($index)" ng-class="{active: start == $index, \'fa-circle\': start == $index, \'fa-circle-thin\': start != $index}"></i><i class="fa fa-angle-double-right nav-list-arrow" ng-click="pageNext()" ng-class="{inactive: start == navArr.length - 1}"></i></span></div></div>',link:function(r,o,s){function c(){r.cards.push({type:"dz-map-card"}),r.user.verifications.pdga&&r.cards.push({type:"dz-pdga-card"}),r.user.verifications.facebook&&r.cards.push({type:"dz-facebook-card"}),r.cards.push({type:"dz-disc-card"}),r.cards.push({type:"dz-date-card"});var e=document.getElementById("card-list");e&&r.cards.forEach(function(t,i){var t=angular.element("<div "+t.type+' user="user" init="init" ng-show="start < '+(i+1)+" && (showCount + start) >= "+(i+1)+'"></div>');e.appendChild(t[0]),a(t)(r)})}r.init=!1,r.showCount=0,r.cards=[],r.navArr=new Array(0),r.start=0,r.contStyle={},r.navIndex=function(e){r.start=e},r.pageBack=function(){r.start=Math.max(r.start-1,0)},r.pageNext=function(){r.start=Math.min(r.start+1,r.navArr.length-1)},r.getAccountImage=function(){return r.user?r.user.image:"/static/img/dz_profile.png"};var l=function(e){"AccountUpdated"===e&&n.compareTo(r.user._id)&&(r.user=n.getAccount())},d=function(){t(function(){var e=angular.element(document.getElementById("card-remain"));r.showCount=Math.floor((o[0].clientWidth-e[0].clientWidth)/220),r.navArr=new Array(Math.ceil(r.cards.length/r.showCount)),r.navArr.length>1?o.addClass("with-nav"):o.removeClass("with-nav"),r.contStyle={maxWidth:220*r.showCount+"px"},r.cardLoaded=!0,r.$apply()})};"undefined"!=typeof r.userId&&i.reloadUser(r.userId,function(e,i){e&&(n.compareTo(i._id)&&n.addListener(l),t(function(){r.user=i;var e=document.getElementById("user-bio");e&&a(e)(r),r.loaded=!0,t(function(){r.ready=!0}),t(function(){c();var e=angular.element(document.getElementById("card-remain"));r.$watch(function(){return e[0].clientWidth},function(e){"undefined"!=typeof e&&e>0&&(d(),r.init=!0)})},1e3)}))}),angular.element(e).bind("resize",d),r.$on("$destroy",function(){angular.element(e).unbind("resize",d),n.removeListener(l)})}}}]).directive("dzPdgaCard",["$timeout",function(e){return{restrict:"A",replace:!0,scope:{user:"="},template:'<div class="profile-card p-icon p-pdga scale-fade"><div class="p-container"><div class="p-icon-text align-vmid"><div class="p-icon-label verified"><span class="fa-stack"><i class="fa fa-certificate fa-stack-2x" aria-hidden="true"></i><i class="fa fa-check fa-stack-1x" aria-hidden="true"></i></span>Verified</div><div class="p-icon-style shadow verified"><i class="fa fa-slack"></i></div><div class="p-icon-label"><a class="dz-blue-hover" target="_blank" ng-href="http://www.pdga.com/player/{{user.pdgaNumber}}">PDGA #{{user.pdgaNumber}}</a></div></div></div></div>',link:function(e,t){}}}]).directive("dzFacebookCard",["$timeout",function(e){return{restrict:"A",replace:!0,scope:{user:"="},template:'<div class="profile-card p-icon p-facebook scale-fade"><div class="p-container"><div class="p-icon-text align-vmid"><div class="p-icon-label verified"><span class="fa-stack"><i class="fa fa-certificate fa-stack-2x" aria-hidden="true"></i><i class="fa fa-check fa-stack-1x" aria-hidden="true"></i></span>Verified</div><div class="p-icon-style shadow verified"><i class="fa fa-facebook-square"></i></div><div class="p-icon-label"><a class="dz-blue-hover" target="_blank" ng-href="https://www.facebook.com/{{user.fbId}}">View Profile</a></div></div></div></div>',link:function(e,t){}}}]).directive("dzDateCard",["$timeout",function(e){return{restrict:"A",replace:!0,scope:{user:"="},template:'<div class="profile-card p-icon p-cal scale-fade"><div class="p-container"><div class="p-icon-text align-vmid"><div class="p-icon-style shadow"><i class="fa fa-calendar"></i></div><div class="p-icon-label">Member Since {{user.dateJoined | dateLocal | date:\'MM/dd/yyyy\'}}</div></div></div></div>',link:function(e,t){}}}]).directive("dzDiscCard",["$timeout",function(e){return{restrict:"A",replace:!0,scope:{user:"="},template:'<div class="profile-card p-count scale-fade"><div class="p-container"><div class="p-count-text align-vmid"><div class="p-count-data">{{user.discCount}}</div><div class="p-count-label">Public Discs</div></div></div></div>',link:function(e,t){}}}]).directive("dzMapCard",["$timeout",function(e){return{restrict:"A",replace:!0,scope:{user:"=",init:"="},template:'<div class="profile-card p-loc scale-fade"><div class="p-container"><div class="align-vmid" id="map-parent"><div id="card-map"></div></div></div></div>',link:function(t,i){var n,a,r;t.mapId=Math.floor(100*Math.random());var o=function(){a=new google.maps.Marker({position:{lat:parseFloat(t.user.geoLat),lng:parseFloat(t.user.geoLng)},animation:google.maps.Animation.DROP,title:t.user.shortLocation,clickable:!1,map:n,icon:{url:"/static/img/disc_marker.png",size:new google.maps.Size(33,49),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(12,49)}})};t.initMap=function(){var e=document.getElementById("card-map");e&&(n=new google.maps.Map(e,{center:{lat:parseFloat(t.user.geoLat),lng:parseFloat(t.user.geoLng)},zoom:4,draggable:!1,scrollwheel:!1,navigationControl:!1,mapTypeControl:!1,scaleControl:!1,disableDoubleClickZoom:!0}),o())};var s=t.$watch("init",function(n){if(n===!0){s();var a=t.$watch(function(){return i[0].style.display},function(i){"undefined"!=typeof i&&"none"!==i&&(a(),e(function(){r||(t.initMap(),r=!0)},300))})}});t.$on("$destroy",function(){n=void 0})}}}]).directive("dzStatusBar",[function(){return{restrict:"E",replace:!0,scope:{showCount:"=",totalCount:"=",breadcrumbs:"=",hideOn:"=",homeUrl:"="},template:'<div class="breadcrumb-container fclear"><div class="pagination-container" title="Showing {{showCount}} of {{totalCount}} results" ng-show="$def(showCount)">{{showCount}} | <span class="dz-blue">{{totalCount}}</span></div><div class="breadcrumb-trail" ng-show="!hideOn"><span class="hover-underline" title="Explore Home"><a ng-href="/{{homeUrl}}"><i class="fa fa-home" style="font-size: 1.1em; color: #008edd"></i></a></span><span class="breadcrumb-item-container" ng-repeat="item in breadcrumbs"><span><i class="fa fa-chevron-right"></i><span ng-if="item.title" style="margin-left: 5px">{{item.title}}:</span></span><span class="breadcrumb-item" ng-repeat="link in item.links track by $index"><span ng-if="$index > 0">|</span><a class="dz-blue hover-underline" ng-if="link.href" ng-href="{{link.href}}">{{link.text}}</a><span class="dz-italic" ng-if="!link.href" ng-href="link.href">{{link.text}}</span></span></span></div><div class="clearfix"></div></div>',link:function(e,t,i){"undefined"==typeof e.homeUrl&&(e.homeUrl="explore"),e.$def=function(e){return"undefined"!=typeof e}}}}]).directive("templateItem",function(){return{restrict:"E",replace:!0,scope:{template:"="},templateUrl:"/static/src/pages/partials/templateItem.html"}}).directive("discItem",["$timeout","QueryService",function(e,t){return{restrict:"E",replace:!0,scope:{disc:"=",currentUser:"=",msOpts:"=",lbOpts:"="},templateUrl:"/static/src/pages/partials/discItem.html",link:function(e,i,n){e.getSolrPrimaryImage=function(e){return t.getSolrPrimaryImage(e)},e.isDef=function(e){return"undefined"!=typeof e},e.setLbOpts=function(){e.lbOpts.discId=e.disc._id,e.lbOpts.show=!0}}}}]).directive("userItem",["CacheService",function(e){return{restrict:"E",replace:!0,scope:{user:"=",profileModal:"="},templateUrl:"/static/src/pages/partials/userItem.html",link:function(t,i,n){e.getUser(t.user._id,function(e,i){e&&(t.location=i.shortLocation,t.user.image=i.image,t.user.discCount=i.discCount,t.discStyle={color:i.discCount>=200?"#008EDD":i.discCount>=50?"#8bd1ff":"#bebebe"},t.init=!0)})}}}]).directive("lightbox",["_","$window","$timeout","CacheService",function(e,t,i,n){return{restrict:"E",replace:!0,scope:{discId:"=",curImg:"=",trigger:"="},templateUrl:"/static/src/pages/partials/lightbox.html",link:function(a,r,o){var s,c,l,d=(document.getElementById("lb-content"),
100),u=85,p=0,f=0;a.isReady,a.index=0,a.showLightbox=!1,a.lbAlert={},a.disc={},a.backdropExit=function(e){e.target==r[0]&&(a.trigger=!1)};var g=function(e){e?document.body.classList.add("scroll-lock"):document.body.classList.remove("scroll-lock")},m=function(){angular.forEach(a.disc.imageList,function(e){var t=new Image;t.src="/files/"+e.fileId})},h=function(e){39==e.keyCode||40==e.keyCode?i(function(){a.index=Math.min(a.disc.imageList.length-1,a.index+1)}):37==e.keyCode||38==e.keyCode?i(function(){a.index=Math.max(0,a.index-1)}):27==e.keyCode&&i(function(){a.trigger=!1})},v=function(){a.isReady||(s=angular.element(document.getElementById("lb-content")),c=angular.element(document.getElementById("lb-image-list")),l=angular.element(document.getElementById("lb-image")),s.bind("keyup",h)),t.innerHeight<t.innerWidth?(f=t.innerHeight-d,s.css("height",f+"px"),s.css("width",t.innerHeight-d+u+"px"),c.css("max-height",f+"px"),l.css("height",f+"px"),l.css("width",f+"px")):(p=t.innerWidth-d,f=p-u,s.css("height",f+"px"),s.css("width",p+"px"),c.css("max-height",f+"px"),l.css("height",f+"px"),l.css("width",f+"px")),s[0].focus(),a.isReady||i(function(){a.isReady=!0})};a.setImage=function(e){i(function(){a.index=e})},a.$watch("trigger",function(t){t===!0?(a.loading=!0,g(t),a.showLightbox=!0,r[0].classList.remove("dz-cloak"),n.getDisc(a.discId,function(t,n){t?(a.disc.primaryImage=n.primaryImage,a.disc.imageList=n.imageList,m(),a.startImg=a.curImg?a.curImg:a.disc.primaryImage,a.index=e.findIndex(a.disc.imageList,function(e){return e._id==a.startImg}),i(v)):a.lbAlert.error={title:"Error",message:"Error loading disc images.",show:!0},a.loading=!1})):t===!1&&(a.showLightbox=!1,g(t),a.disc={})}),angular.element(t).bind("resize",v),a.$on("$destroy",function(){angular.element(t).unbind("resize",v),"undefined"!=typeof s&&s.unbind("keyup",h)})}}}]).directive("dropzonePreview",["$compile",function(e){return{restrict:"A",scope:{},link:function(t,i,n){if("true"!==n.compiled){var a=i[0].querySelector(".image-overlay");i.attr("ng-mouseenter","displayOverlay=true;"),i.attr("ng-mouseleave","displayOverlay=false;"),i.attr("compiled","true"),angular.element(a).attr("ng-show","displayOverlay"),e(i)(t.$parent)}}}}]).directive("dropzone",function(){return function(e,t,i){var n,a;n=e[i.dropzone],a=new Dropzone(t[0],n.options),angular.forEach(n.eventHandlers,function(e,t){a.on(t,e)}),e[i.dropzone].getDropzone=function(){return a}}}).directive("imageCropper",["$window","$timeout","ImageService","PageUtils",function(e,t,i,n){return{restrict:"E",scope:{cropperOptions:"="},template:'<div class="backdrop backdrop-dark photo-crop" ng-show="show" ng-style="{\'top\':topMarg + \'px\'}"><div class="crop-container" ng-style="{\'top\':topInnerMarg + \'px\', \'left\':leftInnerMarg + \'px\'}"><div class="crop-area" id="image-parent"></div><div class="crop-control-area"><div class="crop-control"><button type="button" class="btn btn-default" ng-click="cancel($event)"><span><i class="fa fa-trash fa-tools"></i></span>Cancel</button><button type="button" class="btn btn-primary" ng-click="finish($event)"><span><i class="fa fa-save fa-tools"></i></span>Accept</button></div></div></div></div>',replace:!0,link:function(n,a,r){if(n.cropperOptions){var o,s,c;n.show=!1;var l=function(e){e?document.body.classList.add("scroll-lock"):document.body.classList.remove("scroll-lock")},d=function(){var i=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;t(function(){n.topInnerMarg=(e.innerHeight-500)/2,n.leftInnerMarg=(i-500)/2})},u=function(){var e=document.getElementById("test-crop");o=new Cropper(e,{checkOrientation:!1,aspectRatio:1,autoCropArea:1,dragMode:"move",dragCrop:!1,cropBoxMovable:!1,cropBoxResizable:!1,viewMode:3,built:function(){n.safeApply(function(){n.cropperOptions.cropperLoading=!1})}})};angular.element(e).bind("resize",d),n.$on("$destroy",function(){angular.element(e).unbind("resize load",d)}),n.cropperOptions.showCropper=function(e,i){s=e,c=i,n.safeApply(function(){n.show=!0,l(!0)});var a=document.getElementById("image-parent");a.innerHTML='<img src="'+i+'" id="test-crop" filename="'+e+'"/>',t(u)},n.cancel=function(e){e.preventDefault(),t(function(){n.show=!1,l(!1),n.cropperOptions.onFinish(),o.destroy()})},n.finish=function(e){e.preventDefault(),t(function(){n.cropperOptions.cropperLoading=!0,n.show=!1,l(!1)}),t(function(){var e=o.getCroppedCanvas().toDataURL(),t=i.dataURItoBlob(e);o.destroy(),t.cropped=!0,t.name=s,n.cropperOptions.onFinish(t)},100)},n.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)},d()}}}}]).directive("smartMsg",[function(){return{restrict:"A",replace:!0,scope:{smartMsg:"="},template:"<span></span>",link:function(e,t,i){e.$watch("smartMsg",function(){if(t[0].innerHTML="","undefined"!=typeof e.smartMsg){if("string"==typeof e.smartMsg)return void(t[0].textContent=e.smartMsg);var i=function(e,t){for(var i=[],n=e.exec(t);null!=n;)i.push(n[1]),n=e.exec(t);return i};if(e.smartMsg.hasOwnProperty("smartConfig")){var n=e.smartMsg.smartConfig,a=n.text,r="";if(n.links)for(var o=/\<\!(.+)\>/g,s=i(o,a),c=0;c<s.length;c++){var l=n.links.length>c?n.links[c]:"#";a=a.split("<!"+s[c]+">").join('<a class="hover-underline dz-blue" href="'+l+'">'+s[c]+"</a>")}r="<span>"+a+"</span>",t[0].innerHTML=r}}})}}}]).directive("dzAlert",["$timeout","PageUtils",function(e,t){return{restrict:"E",scope:{alertData:"=",dock:"@"},replace:!0,templateUrl:"/static/src/pages/partials/dzAlert.html",link:function(i,n,a){var r,o="true"===a.forceScroll,s=function(t){var n=t||3e3;r=e(function(){i.alertData={}},n)},c=function(i){i.show&&n[0].classList.remove("dz-cloak"),i.show===!0&&"undefined"!=typeof i.timeout?s(i.timeout):r&&e.cancel(r),o&&e(function(){var e=t.getTop(n[0]);(t.getScrollPos()>e||e>t.getScrollPos()+t.getWindowHeight())&&window.scrollTo(0,e)})};i.$watch("alertData.success.show",function(e){"undefined"!=typeof e&&(i.alertData.error={},i.alertData.info={},c(i.alertData.success))}),i.$watch("alertData.error.show",function(e){"undefined"!=typeof e&&(i.alertData.success={},i.alertData.info={},c(i.alertData.error))}),i.$watch("alertData.info.show",function(e){"undefined"!=typeof e&&(i.alertData.success={},i.alertData.error={},c(i.alertData.info))})}}}]).directive("navBack",["$window",function(e){return{restrict:"A",link:function(t,i,n){i.on("click",function(){e.history.back()})}}}]).directive("dzConfirm",["$timeout",function(e){return{restrict:"E",scope:{label:"@",icon:"@",action:"="},replace:!0,template:'<div class="confirm-button" ng-class="{\'open\': confirmActive}" ng-mouseenter="confirmActive && clearReset()" ng-mouseleave="confirmActive && reset()"><div class="confirm-icon" ng-click="toggle()"><i class="fa fa-{{icon}}" title="{{label}}"></i></div><div class="confirm-button-inner dz-blue-hover" ng-show="confirmActive" ng-click="doAction()">{{label}}? Click to Confirm</div><div class="clearfix"></div></div>',link:function(t,i,n){t.confirmActive=!1;var a;t.doAction=function(){t.action()},t.toggle=function(){t.confirmActive=!t.confirmActive},t.clearReset=function(){e.cancel(a)},t.reset=function(){a=e(function(){t.confirmActive=!1,a=void 0},1e3)}}}}]).directive("fitPage",["$window","$timeout",function(e,t){return{restrict:"A",link:function(i,n,a){var r,o=a.offset?parseInt(a.offset)||0:0,s=function(){r&&t.cancel(r),cancel=t(function(){var t=n[0].children[0];t.clientHeight<=e.innerHeight?angular.element(n).css("height",e.innerHeight+o+"px"):angular.element(n).css("height","auto")},10)};angular.element(e).bind("resize",s),i.$watch(function(){return n[0].children[0].clientHeight},function(e){"undefined"!=typeof e&&s()}),i.$on("$destroy",function(){angular.element(e).unbind("resize",s)}),s()}}}]).directive("dzWrapper",["$window","$timeout",function(e,t){return{restrict:"A",link:function(i,n,a){n.addClass("wrapper");var r=function(){t(function(){angular.element(n).css("min-height",e.innerHeight+"px")})};angular.element(e).bind("resize",r),i.$on("$destroy",function(){angular.element(e).unbind("resize",r)}),r()}}}]).directive("fitBelowPage",["$window",function(e){return{restrict:"A",link:function(t,i,n){var a=n.offset?0|parseInt(n.offset):0,r=function(){angular.element(i).css("marginTop",e.innerHeight+a+"px")};angular.element(e).bind("resize",r),t.$on("$destroy",function(){angular.element(e).unbind("resize",r)}),r()}}}]).directive("centerAlign",function(){return{restrict:"A",transclude:!0,template:'<div style="margin: auto; display: table-cell; vertical-align: middle;" ng-transclude></div>',link:function(e,t,i){angular.element(t).css("display","table").css("width","100%")}}}).directive("toggleClass",[function(){return{restrict:"A",link:function(e,t,i){t.bind("click",function(){t.toggleClass(i.toggleClass)})}}}]).directive("directiveOn",["$compile",function($compile){return{scope:{trigger:"=directiveOn"},restrict:"A",link:function(scope,element,attrs){var directive=eval("("+attrs.directiveSet+")"),setDirective=function(){directive=eval("("+attrs.directiveSet+")");for(var a in directive)element.attr(a,directive[a]);element.removeAttr("directive-on"),element.removeAttr("directive-set"),$compile(angular.element(element[0]))(scope.$parent)};"object"==typeof directive&&(scope.trigger===!0?setDirective():scope.$watch("trigger",function(e,t){e===!0&&setDirective()}))}}}]).directive("infiniteScroll",["$window",function(e){return{restrict:"A",link:function(t,i,n){var a=i[0],r=function(i){var r=a.getBoundingClientRect(),o=r.top+window.pageYOffset-document.documentElement.clientTop;o+a.clientHeight<=e.scrollY+window.innerHeight&&t.$apply(n.infiniteScroll)};angular.element(e).bind("scroll load",r),t.$on("$destroy",function(){angular.element(e).unbind("scroll load",r)})}}}]).directive("ngRepeatFinish",["$parse",function(e){return{restrict:"A",link:function(t,i,n){t.$last&&e(n.ngRepeatFinish)(t)}}}]).directive("imgLoad",[function(){return{restrict:"A",link:function(e,t,i){function n(e){o?t.css("background-image","url("+e+")"):i.$set("src",e)}function a(){var e=new Image;e.addEventListener("load",function(){n(e.src)}),e.src=i.imgSrc,e.complete||n(i.imgLoad||"/static/img/dz_disc.png")}function r(){i.$observe("imgSrc",function(){a()})}var o="true"===i.bgImage;i.imgSrc?a():n(i.imgLoad||"/static/img/dz_disc.png"),r()}}}]).directive("tagList",["$timeout","_","QueryService",function(e,t,i){return{restrict:"E",scope:!0,template:'<div class="text-list"><a class="text-item tag" ng-href="{{getLink(tag)}}" ng-repeat="tag in tagList track by $index" ng-class="{\'large\':$index < limitLarge, \'med\': ($index >= limitLarge && $index < limitMed)}">{{tag.val}}</a></div>',replace:!0,link:function(t,n,a){t.tagList=[],t.getLink=function(e){return"/explore?mode=all-market&q="+encodeURIComponent(e.val)},i.queryFacet({query:"*",limit:0,marketplace:{forSale:!0,forTrade:!0},facet:{name:"tag",limit:50}},function(i,n){i&&n.facets.dynFilters.tag&&e(function(){t.tagList=n.facets.dynFilters.tag.filters||[],t.limitLarge=Math.floor(.25*t.tagList.length),t.limitMed=Math.floor(.5*t.tagList.length)})})}}}]).directive("exploreCategory",["$window","$location","$timeout","_","QueryService",function(e,t,i,n,a){return{restrict:"E",scope:!0,templateUrl:"/static/src/pages/partials/exploreCategory.html",replace:!0,link:function(t,n,r){var o="true"===r.recent;t.fvalue=o?"Recently Added":r.fvalue,t.start=0,t.dispCount=Math.floor(n[0].clientWidth/156),t.exploreList=[];var s=[];o||s.push({name:r.field,fields:[r.fvalue]}),t.getLink=function(){return"/explore?mode=all-market"+(o?"":"&s=new&f_0="+r.field+":"+encodeURIComponent(r.fvalue))},t.navIndex=function(e){t.page=e,t.start=t.page*t.dispCount},t.pageBack=function(){t.page=Math.max(0,t.page-1),t.start=t.page*t.dispCount},t.pageNext=function(){t.page=Math.min(t.page+1,t.navArr.length-1),t.start=t.page*t.dispCount},t.getDisplayCount=function(){i(function(){t.dispCount=Math.floor(n[0].clientWidth/156),t.navArr=new Array(Math.ceil(t.exploreList.length/t.dispCount)),t.page=Math.min(t.page,t.navArr.length-1),t.start=t.page*t.dispCount})};var c=function(){t.getDisplayCount()};angular.element(e).bind("resize",c),t.$on("$destroy",function(){angular.element(e).unbind("resize",c)});var l={query:"*",sort:"new",limit:20,marketplace:{forSale:!0,forTrade:!0}};o||(l.filter=s,l.group={limit:3,field:"userId"}),a.queryAll(l,function(e,i){if(e){if(o)Array.prototype.push.apply(t.exploreList,i.results);else for(var n in i.results)Array.prototype.push.apply(t.exploreList,i.results[n]);t.navArr=new Array(Math.ceil(t.exploreList.length/t.dispCount))}})}}}]).directive("modalTrigger",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",scope:{modalOpts:"="},link:function(scope,elem,attrs){var data={};if(attrs.data){var dataExp=eval("("+attrs.data+")");for(var a in dataExp)data[a]=$parse(dataExp[a])(scope.$parent)}var showModal=function(){$timeout(function(){scope.modalOpts.data=data,scope.modalOpts.type=attrs.modalTrigger,scope.modalOpts.show=!0})};scope.$on("$destroy",function(){elem.unbind("click",showModal)}),elem.bind("click",showModal)}}}]).directive("dzModal",["$compile","$window","$timeout",function(e,t,i){return{restrict:"E",scope:{modalOpts:"="},replace:!0,template:'<div class="full-screen-backdrop no-select" ng-show="showModal"><div class="dz-modal-container" id="dz-modal"><i class="dz-modal-close fa fa-times" aria-hidden="true" ng-click="!childOpts.lock && (modalOpts.show = false)"></i><div id="dz-modal-inner"></div></div></div>',link:function(n,a,r){n.childOpts={lock:!1,doOnClose:!1};var o=function(e){e?document.body.classList.add("scroll-lock"):document.body.classList.remove("scroll-lock")};n.resize=function(){var e=document.getElementById("dz-modal");i(function(){angular.element(e).css("max-height",.8*t.innerHeight+"px")})},n.$on("$locationChangeStart",function(e){o(!1)}),n.$watch("modalOpts.show",function(t){if("undefined"!=typeof t){var a=document.getElementById("dz-modal-inner");if(a.innerHTML="",!t)return o(t),n.showModal=!1,void("undefined"!=typeof n.modalOpts.data&&"undefined"!=typeof n.modalOpts.data.onClose&&n.modalOpts.data.onClose(n.childOpts.doOnClose));var r=angular.element("<"+n.modalOpts.type+' data="modalOpts.data" show="modalOpts.show" lock="childOpts.lock" do-on-close="childOpts.doOnClose" '+(n.modalOpts.partial?'partial="'+n.modalOpts.partial+'"':"")+"></"+n.modalOpts.type+">");a.appendChild(r[0]),e(r)(n),o(t),i(function(){n.showModal=!0})}}),n.$on("$destroy",function(){angular.element(t).unbind("resize",n.resize)}),angular.element(t).bind("resize",n.resize),n.resize()}}}]).directive("dzFeedbackModal",["APIService",function(e){return{restrict:"E",scope:{data:"=data",show:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzFeedbackModal.html",link:function(t,i,n){t.feedback="",t.feedbackAlert={},t.submit=function(){var i={data:t.feedback};e.Post("/feedback",i,function(e,i){e?t.show=!1:t.feedbackAlert.error={title:i.type,message:i.message,show:!0}})}}}}]).directive("dzInfoModal",["$window","$timeout","$templateRequest","$compile",function(e,t,i,n){return{restrict:"E",scope:{data:"=data",show:"="},replace:!0,template:'<div><div class="dz-modal-content"><div class="dz-modal-title-info" id="modal-title"><i class="fa fa-question-circle fa-tools"></i></div><div id="modal-body" style="overflow:auto;"></div></div><div class="dz-modal-btn-container"><div class="dz-modal-triangle"></div><div class="dz-modal-btn cancel" ng-click="show = false">Close</div></div></div>',link:function(a,r,o){var s=document.getElementById("modal-body");document.getElementById("modal-title").innerHTML+=a.data.title,i("/static/src/pages/partials/"+o.partial,!0).then(function(e){var t=angular.element(e);s.appendChild(t[0]),n(t)(a)}),a.resize=function(){t(function(){angular.element(s).css("max-height",.8*e.innerHeight-200+"px")})},a.$on("$destroy",function(){angular.element(e).unbind("resize",a.resize)}),angular.element(e).bind("resize",a.resize),a.resize()}}}]).directive("dzBumpModal",["_","DiscService",function(e,t){return{restrict:"E",scope:{data:"=data",show:"=",lock:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzBumpModal.html",link:function(e,i,n){e.tableOpts={isCounter:!0,isDisc:!0,headerText:"Disc",defaultText:"Bump Ready",items:e.data.discs},e.opts={},e.modalAlert={},e.confirm=function(){var i=document.getElementById("modal-table-content");i.scrollTop=0;var n=function(a,r,o){var s=a[r];"undefined"!=typeof s.countdown&&s.countdown.bumpReady&&t.bumpDisc(s._id,function(t,c){t?(s.countdown.bumpRemaining=c.bumpRemaining,s.countdown.bumpReady=!1):e.modalAlert.error={title:c.type,message:c.message,show:!0},r>4&&(i.scrollTop+=30),r<a.length-1?n(a,r+1,o):o()})};e.opts.loading=!0,e.doOnClose=!0,e.lock=!0,n(e.data.discs,0,function(){e.opts.loading=!1,e.opts.disableBump=!0,e.lock=!1})}}}}]).directive("dzTagModal",["_","$timeout","DiscService",function(e,t,i){return{restrict:"E",scope:{data:"=data",show:"=",lock:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzTagModal.html",link:function(n,a,r){var o=e.intersection.apply(e,e.pluck(n.data.discs,"tag"));n.newTags=o.slice(),n.tempTag="",n.opts={},n.modalAlert={},n.tagAlert={},n.overwriteAlert={},n.tableOpts={isDisc:!0,headerText:"Disc",successText:"Saved",defaultText:"Unchanged",items:n.data.discs},n.removeNewTag=function(e){n.newTags.splice(e,1)[0]},n.pushTempTag=function(){"undefined"!=typeof n.tagAlert.error&&(n.tagAlert.error.show=!1),n.tempTag&&n.tempTag.length&&(e.contains(n.newTags,n.tempTag)?n.tagAlert.error={title:"Error",message:'"'+n.tempTag+'" already exists as a common tag.',show:!0}:(n.newTags.push(n.tempTag),n.tempTag=""))},n.confirm=function(){var t=document.getElementById("modal-table-content");t.scrollTop=0;var a=e.difference(o,n.newTags),r=function(o,s,c){var l=o[s],d="undefined"!=typeof l.tag?l.tag:[];d=n.opts.overwrite?n.newTags:e.uniq(e.union(e.difference(d,a),n.newTags)),"undefined"!=typeof l.success&&(l.success=!1),"undefined"!=typeof l.error&&(l.error=!1),i.editDisc({tagList:d,_id:l._id},function(e,i){e?l.success=!0:l.error=!0,s>4&&(t.scrollTop+=30),s<o.length-1?r(o,s+1,c):c()})};n.opts.loading=!0,n.doOnClose=!0,n.lock=!0,r(n.data.discs,0,function(){n.tagAlert.info={title:"Finished",message:"Tag update is complete.",show:!0},o=n.newTags.slice(),n.opts.allowSave=!1,n.opts.loading=!1,n.lock=!1})},n.$watch("show",function(e){t(function(){e===!0&&(n.opts.isShowing=!0)},500)}),n.$watch("opts.overwrite",function(e){"undefined"!=typeof e&&(e?(n.opts.allowSave=!0,n.overwriteAlert.info={message:"Enabling this option will REPLACE all tags across all selected discs with the tag list shown above!",hideClose:!0,show:!0}):n.overwriteAlert.info.show=!1)}),n.$watchCollection("newTags",function(t){if("undefined"!=typeof t)if(t.length!=o.length)n.opts.allowSave=!0;else{var i=e.intersection(t,o);n.opts.allowSave=i.length!=t.length}})}}}]).directive("dzProfileModal",["_","$compile","$window","$timeout","$location","CacheService","MembershipService","AccountService",function(e,t,i,n,a,r,o,s){return{restrict:"E",scope:{data:"=data",show:"=",lock:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzProfileModal.html",link:function(c,l,d){var u,p=document.getElementById("modal-bio"),f=document.getElementById("profile-table"),g=document.getElementsByClassName("dz-modal-profile-cell");c.opts={},c.modalAlert={},c.getUserImage=function(){return c.user.image,c.user.image},c.getAccountName=function(){return o.getAccountName(c.user.accountType)},c.initMessage=function(){a.path("/inbox").search("userId",c.user._id)},c.viewTrunk=function(){a.path("/t/"+c.user.username).search({})},c.viewAccount=function(){a.path("/account").search({})},c.resize=function(){n(function(){angular.element(p).css("max-height",.8*i.innerHeight-300+"px"),u=f.offsetWidth/3,e.each(g,function(e){angular.element(e).css("width",u+"px"),angular.element(e).css("max-width",u+"px")})})},c.$on("$destroy",function(){angular.element(i).unbind("resize",c.resize)}),angular.element(i).bind("resize",c.resize),c.opts.loading=!0,c.lock=!0;var m=a.path();c.isTrunk=m.search("/t/")!=-1,r.getUser(c.data.userId,function(e,i){e?(c.user=i,c.isOwner=s.compareTo(i._id),p&&t(p)(c),c.userInit=!0):c.modalAlert.error={title:"Error",message:"Error retrieving profile.",show:!0},c.opts.loading=!1,c.lock=!1}),n(function(){c.resize()})}}}]).directive("dzDeleteAccountModal",["AccountService",function(e){return{restrict:"E",scope:{data:"=data",show:"=",lock:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzDeleteAccountModal.html",link:function(t,i,n){t.opts={},t.modalAlert={},t.getAccountImage=function(){return e.getAccountImage()},t.confirm=function(){t.opts.loading=!0,t.lock=!0,e.doAccountDelete(function(e,i){e&&"OK"==i.status?(t.modalAlert.success={title:"Success",message:"An email confirmation has been sent to your email address.",show:!0},t.opts.confirmed=!0):t.modalAlert.error={title:"Error",message:"An error occurred while attempting to delete your account.",show:!0},t.opts.loading=!1,t.lock=!1})}}}}]).directive("dzDeleteDiscModal",["DiscService",function(e){return{restrict:"E",scope:{data:"=data",show:"=",lock:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzDeleteDiscModal.html",link:function(t,i,n){t.opts={},t.modalAlert={},t.tableOpts={isDisc:!0,headerText:"Disc",successText:"Deleted",defaultText:"Unchanged",items:t.data.discs},t.confirm=function(){var i=document.getElementById("modal-table-content");i.scrollTop=0;var n=function(t,a,r){var o=t[a];e.deleteDisc(o,function(e,s){e?o.success=!0:o.error=!0,a>4&&(i.scrollTop+=30),a<t.length-1?n(t,a+1,r):r()})};t.opts.loading=!0,t.doOnClose=!0,t.lock=!0,n(t.data.discs,0,function(){t.modalAlert.info={title:"Finished",message:"Disc deletion is complete.",show:!0},t.opts.loading=!1,t.lock=!1})}}}}]).directive("dzVisibilityModal",["DiscService",function(e){return{restrict:"E",scope:{data:"=data",show:"=",lock:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzVisibilityModal.html",link:function(t,i,n){t.opts={},t.modalAlert={},t.tableOpts={isDisc:!0,isVisibility:!0,headerText:"Disc",items:t.data.discs},t.makePublic=!0,t.confirm=function(){var i=document.getElementById("modal-table-content");i.scrollTop=0;var n=function(a,r,o){var s=a[r];"undefined"!=typeof s.success&&(s.success=!1),"undefined"!=typeof s.error&&(s.error=!1),e.editDisc({visible:t.makePublic,_id:s._id},function(e,c){e?(s.visible=t.makePublic,s.success=!0):s.error=!0,r>4&&(i.scrollTop+=30),r<a.length-1?n(a,r+1,o):o()})};t.opts.loading=!0,t.doOnClose=!0,t.lock=!0,n(t.data.discs,0,function(){t.opts.loading=!1,t.lock=!1})}}}}]).directive("dzMarketplaceModal",["DiscService","AccountService",function(e,t){return{restrict:"E",scope:{data:"=data",show:"=",lock:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzMarketplaceModal.html",link:function(i,n,a){i.opts={},i.modalAlert={},i.tempMarketplace={forSale:!1,forTrade:!1},i.tableOpts={isDisc:!0,isMarketplace:!0,headerText:"Disc",items:i.data.discs},i.confirm=function(){var n=document.getElementById("modal-table-content");n.scrollTop=0;var a=function(t,n,a){var o=t[n];return o.ineligible?r(t,n,a):(o.success=!1,o.error=!1,void e.editDisc({marketplace:i.tempMarketplace,_id:o._id},function(e,s){return e?(o["marketplace.forSale"]=i.tempMarketplace.forSale,o["marketplace.forTrade"]=i.tempMarketplace.forTrade,o.success=!0):o.error=!0,r(t,n,a)}))},r=function(e,t,i){return t>4&&(n.scrollTop+=30),t<e.length-1?a(e,t+1,i):i()};i.opts.loading=!0,i.doOnClose=!0,i.lock=!0,a(i.data.discs,0,function(){t.getAccountMarket(function(e,t){e||(i.modalAlert.error={title:"Error",message:"Error updating marketplace remaining count.",show:!0}),i.data.marketData.marketAvailable=t.marketAvailable}),i.opts.loading=!1,i.lock=!1})}}}}]).directive("dzShareModal",["_","$location","$timeout","QueryService","AccountService","FacebookUtils",function(e,t,i,n,a,r){return{restrict:"E",scope:{data:"=data",show:"=",lock:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzShareModal.html",link:function(o,s,c){o.linkOpts={},o.modalAlert={},o.fbModalAlert={},o.loading={fb:!0},o.formData={linkType:"full"};var l=t.absUrl().replace(t.url(),""),d=function(e){return n.getSolrPrimaryImage(e)},u=function(t){if("undefined"!=typeof t){var i=e.findWhere(t.imageList,{_id:t.primaryImage});return"undefined"==typeof i?"/static/img/dz_disc.png":"/files/"+i.thumbnailId}},p=function(e){r.initFacebook().then(function(){r.scrapePath(e,function(e){i(function(){e?o.fbModalAlert.error={title:"Facebook Unavailable",message:"Facebook is unavailable at this time. Please try again.",show:!0}:o.facebookInit=!0,o.loading.fb=!1})})})},f=function(){o.isDisc?o.linkOpts.link=l+"/d/"+o.data.disc._id:o.isTrunk&&("base"==o.formData.linkType?o.linkOpts.link=l+"/t/"+o.data.user.username:"full"==o.formData.linkType&&(o.linkOpts.link=t.absUrl())),i(function(){document.getElementById("input-link").select()})};o.getDiscImage=function(t){if("undefined"!=typeof t)return e.isArray(t.imageList)?u(t):d(t)},o.getAccountImage=function(){return o.data.user?o.data.user.image:"/static/img/dz_profile.png"},o.shareFB=function(){o.isDisc?r.shareFacebook("/d/"+o.data.disc._id):o.isTrunk&&r.shareFacebook("/t/"+o.data.user._id)},o.showLink=function(){o.linkOpts.linkSelected=!0,f()},o.$watch("formData.linkType",function(e){"undefined"!=typeof e&&f()}),"undefined"!=typeof o.data.disc?(o.isDisc=!0,o.typeText="disc",o.modalAlert.info={title:"Note",message:"A shared link will be broken if this disc is marked private.",hideClose:!0,show:!0},p("/d/"+o.data.disc._id)):"undefined"!=typeof o.data.user&&(o.isOwner=a.compareTo(o.data.user._id),o.isTrunk=!0,o.typeText="trunk",o.isOwner&&(o.modalAlert.info={title:"Note",message:"Only your public discs will be visible when sharing your trunk.",hideClose:!0,show:!0}),p("/t/"+o.data.user.username))}}}]).directive("dzAcknowledgementModal",["DiscService",function(e){return{restrict:"E",scope:{data:"=data",show:"=",doOnClose:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzAcknowledgementModal.html",link:function(e,t,i){"undefined"!=typeof e.data.message1&&(document.getElementById("modal-message-1").innerHTML=e.data.message1),"undefined"!=typeof e.data.message2&&(document.getElementById("modal-message-2").innerHTML=e.data.message2),e.confirm=function(){e.doOnClose=!0,e.show=!1}}}}]).directive("dzModalTable",["_","QueryService","DiscService",function(e,t,i){return{restrict:"E",scope:{successText:"=",defaultText:"=",tableOpts:"="},replace:!0,templateUrl:"/static/src/pages/partials/dzModalTable.html",link:function(n,a,r){var o=function(e){return t.getSolrPrimaryImage(e)},s=function(t){var i=e.findWhere(t.imageList,{_id:t.primaryImage});return"/files/"+i.thumbnailId};n.getImage=function(t){if(n.tableOpts.isDisc)return e.isArray(t.imageList)?s(t):o(t)},n.$watch("tableOpts.isCounter",function(t){"undefined"!=typeof t&&t===!0&&e.each(n.tableOpts.items,function(e){(e["marketplace.forSale"]||e["marketplace.forTrade"])&&(e.countdown={},e.countdown.loading=!0,i.getBumpRemaining(e._id,function(t,i){t?(e.countdown.bumpRemaining=i.bumpRemaining,e.countdown.init=!0):e.error=!0,e.countdown.loading=!1}))})})}}}]).directive("ngEnter",["$timeout",function(e){return{restrict:"A",link:function(t,i,n){"undefined"!=typeof n.ngEnterLock&&i.bind("keydown",function(e){13!==e.which||e.shiftKey||e.preventDefault()}),i.bind("keyup",function(i){13!==i.which||i.shiftKey||(i.preventDefault(),i.stopImmediatePropagation(),e(function(){t.$eval(n.ngEnter),i.preventDefault()}))})}}}]).directive("ngModelEnter",["$timeout",function(e){return{restrict:"A",require:"ngModel",link:function(t,i,n,a){i.bind("keyup",function(i){13!==i.which||i.shiftKey||(i.stopImmediatePropagation(),e(function(){a.$commitViewValue(),t.$eval(n.ngModelEnter),i.preventDefault()}))})}}}]).controller("MainController",["$rootScope","$scope","$location","AccountService","_","APIService","QueryService","SocketUtils","DiscService",function(e,t,i,n,a,r,o,s,c){t.Math=window.Math,t.nav=function(e,t){i.path("/"+(e?e:"")).search({}),t&&i.replace()},t.navExplore=function(e){i.path("/explore").search("q",e)},t.$def=function(e){return"undefined"!=typeof e},t.safeApply=function(e){if(this.$root&&this.$root.$$phase){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)}},t.containsStr=function(e,t){return a.contains(e,String(t))},t.getUserImage=function(e){return e.image?e.image:"/static/img/dz_profile.png"},t.getPrimaryImage=function(e){if(e.primaryImage){var t=a.findWhere(e.imageList,{_id:e.primaryImage});if(t)return"/files/"+t.fileId}return"/static/img/dz_disc.png"},t.log=function(e){console.log(e)},t.getSolrPrimaryImage=function(e){return o.getSolrPrimaryImage(e)},t.toggle=function(e){e=!e}}]).controller("PortalController",["$scope","$location","$window","$timeout","smoothScroll","PageUtils",function(e,t,i,n,a,r){var o,s=document.getElementById("explore-start");t.search({}),e.transform="rotate(0deg)",e.scrollPage=function(){var e={duration:700,easing:"easeInQuad",offset:50};a(s,e)};var c=function(){var t=Math.min(180,r.getScrollPos());t!=o&&(n(function(){e.transform="rotate("+t+"deg)"}),o=t)};angular.element(document).bind("scroll",c),e.$on("$destroy",function(){angular.element(document).unbind("scroll",c)})}]).controller("TrunksController",["$scope","$location","$routeParams","$window","_","$timeout","smoothScroll","QueryUserService","CacheService","AccountService","LocationService","PageUtils","PageCache","PropService",function(e,t,i,n,a,r,o,s,c,l,d,u,p,f){var g,m=!0,h=f.get("TrunkReqSize"),v=!1,b=!1;angular.element(document.getElementById("location-search")),document.getElementById("location-results");e.curUser=l.getAccount(),e.activeFilters=[],e.breadcrumbs=[],e.resultList=[],e.resultFilters={},e.location={results:[],loading:!1,locSet:!1},e.pagination={start:0,total:0},e.units="miles",e.statusHome="trunks",e.searchParam="",e.sortParam="rel",e.loading=!0,e.loadingMore=!1,e.itemSelected=function(){e.setLocation(e.location.results[e.location.selResult])};var y=function(){e.breadcrumbs=[],e.searchParam.length&&e.breadcrumbs.push({title:"Searching",links:[{text:'"'+e.searchParam+'"'}]}),e.geo&&e.geo.distance&&(e.breadcrumbs.push({title:"In",links:[{text:e.location.curLocation}]}),e.breadcrumbs.push({title:"Radius",links:[{text:e.geo.distance+" "+e.units,href:"/trunks?d="+e.geo.distance}]}));var i=[];a.each(e.activeFilters,function(n){var r={title:n.text,links:[]},o={name:n.name,fields:[]};i.push(o),a.each(n.fields,function(n){o.fields.push(n),r.links.push({text:"true"===n?"Active":n,href:t.path()+s.getQueryString({query:e.searchParam,sort:v?e.sortParam:void 0,locSet:e.location.locSet,filter:i,geo:e.geo})})}),e.breadcrumbs.push(r)})};e.loadMore=function(){if(!(e.loading||m||b)&&(b=!0,e.resultList.length<e.pagination.total)){var t=e.resultList.length;e.pagination.start=t,e.performSearch(!0)}},e.locationAllowed=function(){return d.isLocationAvailable()},e.hideLocResults=function(){r(function(){e.location.editable=!1,e.location.loading=!1,e.location.search="",e.location.selResult=-1},300)},e.setLocation=function(t){e.location.editable=!1,e.location.curLocation=t.address,e.geo||(e.geo={}),e.geo.latitude=t.latitude,e.geo.longitude=t.longitude,e.location.locSet=!0,e.updateUrl()},e.$watch("location.search",function(t){e.location.selResult=-1,t&&t.length>3?(e.location.loading=!0,d.getGeoLocation(t,function(t,i){t?(e.location.results=i,e.location.selResult=-1):e.location.results=[],e.location.loading=!1})):e.location.results=[]}),e.startSearch=function(){e.activeFilters=[],e.geo=void 0,e.sortParam=void 0,e.updateUrl()},e.isFilterActive=function(t,i){var n=a.find(e.activeFilters,{name:t.prop});return i.active=n&&e.containsStr(n.fields,i.val),i.active},e.hasActiveFilters=function(t){var i=a.find(e.activeFilters,{name:t.prop});return i&&i.fields.length;
},e.clearActiveFilters=function(t,i){e.activeFilters=a.filter(e.activeFilters,function(e){return e.name!=t.prop}),i||e.updateUrl()},e.toggleFilter=function(t,i){var n=a.find(e.activeFilters,{name:t.prop});n?e.containsStr(n.fields,i.val)?n.fields=a.without(n.fields,String(i.val)):n.fields.push(i.val):e.activeFilters.push({name:t.prop,text:t.text,fields:[i.val]}),e.activeFilters=a.filter(e.activeFilters,function(e){return e.fields.length>0}),e.updateUrl()},e.toggleVerification=function(t){e.toggleFilter(t,{val:!0})},e.isVerificationActive=function(t){return e.isFilterActive(t,{val:!0})},e.hasVerificationsActive=function(){if("undefined"==typeof e.resultFilters.statFilters)return!1;var t=a.filter(e.activeFilters,function(t){return typeof("undefined"!==e.resultFilters.statFilters[t.name])});return t.length},e.clearActiveVerifications=function(){a.each(e.resultFilters.statFilters,function(t){e.clearActiveFilters(t,!0)}),e.updateUrl()},e.updateUrl=function(){e.pagination.start=0,t.url(t.path()+s.getQueryString({query:e.searchParam,sort:v?e.sortParam:void 0,filter:e.activeFilters,geo:e.geo,locSet:e.location.locSet}))},e.updateLocation=function(){e.geo&&e.geo.latitude&&e.geo.longitude?(e.location.loading=!0,d.getReverseGeo(e.geo.latitude,e.geo.longitude,function(t,i){t&&i.length?e.location.curLocation=i[0].address:e.location.curLocation="Unknown",e.location.loading=!1,y()})):(e.location.curLocation=void 0,y())},e.performSearch=function(t){t?e.loadingMore=!0:(e.loading=!0,e.pagination.start=0);var i="undefined"!=typeof g&&!g.loaded;s.queryAll({query:e.searchParam,sort:e.sortParam,filter:e.activeFilters,start:i?0:e.pagination.start,limit:i?Math.max(g.loadCount,h):h,geo:e.geo},function(n,a){n&&(i&&(g.loaded=!0),e.pagination.start=a.start,e.pagination.total=a.total,t?Array.prototype.push.apply(e.resultList,a.results):(e.resultList=a.results,e.resultFilters=a.facets)),e.updateLocation(),e.loading=!1,e.loadingMore=!1,b=!1})},e.onLastUser=function(){e.resizeRes(function(){"undefined"==typeof g||g.scrolled||(window.scrollTo(0,g.scrollPos),g.scrolled=!0);var t=document.getElementById("results-list");u.getWindowHeight()>u.getFullHeight(t)&&e.pagination.total>e.resultList.length&&e.loadMore()})},e.resizeRes=function(e){var t=document.getElementById("results-container"),i=document.getElementById("results-list"),n=document.getElementById("result-header-static"),a=document.getElementById("result-header-fluid");r(function(){if(angular.element(i).css("width",207*Math.floor(t.clientWidth/207)+"px"),angular.element(a).css("padding-right",n.clientWidth+10+"px"),"function"==typeof e)return e()})},e.$on("$locationChangeStart",function(){p.setData({loadCount:e.resultList.length,routeTime:new Date,scrollPos:u.getScrollPos()})}),e.updateSort=function(){v=!0,e.updateUrl()},e.setProximity=function(t){t?e.geo&&(e.geo.distance=t.val):e.geo.distance=void 0,e.updateUrl()},e.isProximityActive=function(t){return t?e.geo&&e.geo.distance==t.val:e.geo&&e.geo.distance},e.$watch("fullscreen",function(t){r(function(){e.resizeRes()})}),e.getLocation=function(t,i){var n=t;"undefined"==typeof t&&e.geo&&e.geo.distance&&(n=e.geo.distance),d.getLocation(function(n,a){n?(e.geo={latitude:a.latitude,longitude:a.longitude,distance:t},e.location.locSet=!1):(e.geo={},e.location.locSet=!1),i?i():e.performSearch()})};var w=function(t){t||(t={});var i=e.geo&&"undefined"!=typeof e.geo.distance,n=e.geo&&"undefined"!=typeof e.geo.latitude&&"undefined"!=typeof e.geo.longitude;if(t.sort)switch(t.sort){case"proximity":e.sortParam=i||n?t.sort:"rel";break;default:e.sortParam=t.sort}else t.search.length?e.sortParam="rel":i||n?e.sortParam="proximity":e.sortParam="rel";e.performSearch()};e.$watch(function(){return t.url()},function(i){if(i&&/^\/(trunks)/.test(i)){if(p.isNavBack()){var n=p.getPageData();n&&(g=n)}var a=s.parseUrlQuery(t.search()),r=a.geo&&"undefined"!=typeof a.geo.distance;a.geo&&a.geo.latitude&&a.geo.longitude;e.activeFilters=a.filters,e.searchParam=a.search,a.geo?a.geo.latitude&&a.geo.longitude?(e.geo={latitude:a.geo.latitude,longitude:a.geo.longitude,distance:a.geo.distance},e.location.locSet=!0,w(a)):r&&e.getLocation(a.geo.distance,function(){w(a)}):e.getLocation(void 0,function(){w(a)})}}),e.$on("$destroy",function(){angular.element(n).unbind("resize",e.resizeRes)}),angular.element(n).bind("resize",e.resizeRes),e.resizeRes(),m=!1}]).controller("ExploreController",["$scope","$location","$routeParams","$window","$q","_","$timeout","QueryService","CacheService","AccountService","DiscService","RedirectService","APIService","MembershipService","PageCache","PageUtils","PropService",function(e,t,i,n,a,r,o,s,c,l,d,u,p,f,g,m,h){function v(t){for(var i=0;i<t.filters.length;i++){var n=t.filters[i];n.count||e.isFilterActive(t,n)||(t.filters.splice(i,1),i--)}}var b,y=!0,w=!1,k=h.get("ExploreReqSize"),A=!1;e.view={},e.curUser=l.getAccount(),e.activeFilters=[],e.breadcrumbs=[],e.resultList=[],e.resultFilters=[],e.trunk={},e.lbOpts={},e.alertOpts={},e.isOwnedTrunk=i.username&&e.curUser&&i.username===e.curUser.username,e.marketplace={forSale:!e.isOwnedTrunk,forTrade:!e.isOwnedTrunk,all:e.isOwnedTrunk},e.pagination={start:0,total:0},e.searchParam="",e.sortParam=h.get("ExploreDefSort"),e.loading=!0,e.loadingMore=!1,e.msOpts={active:!1,count:0,loading:!1,showIneligible:!1,showNoCount:!1};var $=function(){b={loadCount:e.resultList.length,routeTime:new Date,scrollPos:m.getScrollPos()},e.handleUrl()},I=function(t){e.loadMore(e.pagination.total,function(){if(k=20,t)return t()})};e.shareTrunk=function(){e.globalModalOpts={type:"dz-share-modal",show:!0,data:{user:e.trunk.user}}},e.msOpts.showMsHelp=function(){e.globalModalOpts={type:"dz-info-modal",show:!0,data:{title:"Multi-select Toolbox Help"},partial:"dzMsInfo.html"}},e.hasMsPermission=function(t){if(e.curUser)return f.hasPermission(t,e.curUser.accountType)};var x=function(){e.msOpts.loading=!0,e.msOpts.count=0,I(function(){o(function(){r.each(e.resultList,function(t){t.selected=!0,e.msOpts.count+=1}),e.msOpts.loading=!1})})};e.msOpts.selectAll=function(){var t=e.pagination.total-e.resultList.length;t>40?e.globalModalOpts={type:"dz-acknowledgement-modal",show:!0,data:{message1:"You are attempting to load and select "+t+" more discs.  Please be patient if you wish to proceed.",message2:"Do you wish to proceed?",onClose:function(e){e&&x()}}}:x()},e.msOpts.deselectAll=function(){e.msOpts.count=0;var t=r.where(e.resultList,{selected:!0});r.each(t,function(e){e.selected=!1})},e.msOpts.setVisibility=function(){var t=r.where(e.resultList,{selected:!0});t.length&&(e.globalModalOpts={type:"dz-visibility-modal",show:!0,data:{discs:t,onClose:function(t){l.getAccount(function(t,i){e.curUser=i}),t&&$()}}})},e.msOpts.setMarketplace=function(){var t=r.where(e.resultList,{selected:!0}),i=!1;r.each(t,function(e){"undefined"!=typeof e["imageList.0._id"]&&e.visible||(e.ineligible=!0,i=!0)}),t.length&&(e.globalModalOpts={type:"dz-marketplace-modal",show:!0,data:{isIneligible:i,marketData:e.marketData,discs:t,onClose:function(e){e&&$()}}})},e.msOpts.bumpDiscs=function(){var t=r.where(e.resultList,{selected:!0});t.length&&(e.globalModalOpts={type:"dz-bump-modal",show:!0,data:{discs:t,onClose:function(e){e&&$()}}})},e.msOpts.manageTags=function(){var t=r.where(e.resultList,{selected:!0});t.length&&(e.globalModalOpts={type:"dz-tag-modal",show:!0,data:{discs:t,user:e.trunk.user._id,onClose:function(e){e&&$()}}})},e.msOpts.deleteDiscs=function(){var t=r.where(e.resultList,{selected:!0});t.length&&(e.globalModalOpts={type:"dz-delete-disc-modal",show:!0,data:{discs:t,onClose:function(e){e&&$()}}})},e.msOpts.toggleMS=function(){e.msOpts.active=!e.msOpts.active,e.msOpts.active||e.msOpts.deselectAll()},e.msOpts.toggleSelected=function(t){t.selected=!t.selected,t.selected?e.msOpts.count+=1:e.msOpts.count-=1};var T=function(e){var t=e.match(/\[(\d+)\s?TO\s?(\d+|\*)\]/);return 3!=t.length?e:"$"+t[1]+("*"===t[2]?"+":" - $"+t[2])},S=function(){e.breadcrumbs=[],e.searchParam.length&&e.breadcrumbs.push({title:"Searching",links:[{text:'"'+e.searchParam+'"'}]}),e.breadcrumbs.push({title:"Showing",links:[{text:e.marketplace.forSale?e.marketplace.forTrade?"For Sale and Trade":"For Sale":e.marketplace.forTrade?"For Trade":"All Discs"}]}),"undefined"!=typeof e.view.visible&&e.breadcrumbs.push({title:"Displaying",links:[{text:e.view.visible?"Public Only":"Private Only"}]});var i=[];r.each(e.activeFilters,function(n){var a={title:n.text,links:[]},o={name:n.name,fields:[]};i.push(o),r.each(n.fields,function(n){var r=n;/\[\d+\s?TO\s?(?:\d+|\*)\]/.test(n)&&(r=T(n)),o.fields.push(n),a.links.push({text:r,href:t.path()+s.getQueryString({query:e.searchParam,sort:w?e.sortParam:void 0,filter:i,marketplace:e.marketplace,visible:e.view.visible})})}),e.breadcrumbs.push(a)})};e.loadMore=function(t,i){if(!(e.loading||y||A))if(A=!0,e.resultList.length<e.pagination.total){var n=e.resultList.length;t&&(k=Math.min(e.pagination.total,t)-n),e.pagination.start=n,e.performSearch(!0,i)}else A=!1,i&&i()},e.getVisibleTitle=function(){return"undefined"==typeof e.view.visible?"Displaying All":e.view.visible?"Displaying Public":"Displaying Private"},e.toggleVisibillty=function(){"undefined"==typeof e.view.visible?e.view.visible=!0:e.view.visible?e.view.visible=!1:e.view.visible=void 0,e.updateUrl()},e.startSearch=function(){e.activeFilters=[],e.sortParam=void 0,e.updateUrl()},e.updateUrl=function(){e.pagination.start=0,t.url(t.path()+s.getQueryString({query:e.searchParam,sort:w?e.sortParam:void 0,filter:e.activeFilters,marketplace:e.marketplace,visible:e.view.visible}))},e.marketMode=function(){return e.marketplace.forSale||e.marketplace.forTrade};var C=function(t){for(var i in t){var n=t[i];n.open=!0;for(var a=0;a<n.filters.length;a++)a==n.filters.length-1?(n.filters[a].text="$"+n.filters[a].val+"+",n.filters[a].val="["+n.filters[a].val+" TO *]"):(n.filters[a].text="$"+n.filters[a].val+" - $"+n.filters[a+1].val,n.filters[a].val="["+n.filters[a].val+" TO "+n.filters[a+1].val+"]");var o=r.findWhere(e.activeFilters,{name:i});if(o)for(var a=0;a<o.fields.length;a++)if(s.isCustomRange(o.fields[a])){var c=o.fields[a].match(/^\[(\d+) TO (\d+)\]$/);if(c.length>2){n.custom={enable:!0,lBound:parseInt(c[1]),uBound:parseInt(c[2])};break}}}};e.performSearch=function(t,i){t?e.loadingMore=!0:(e.loading=!0,e.pagination.start=0);var n="undefined"!=typeof b&&!b.loaded;s.queryAll({query:e.searchParam,sort:e.sortParam,filter:e.activeFilters,start:n?0:e.pagination.start,valueRange:!0,limit:n?Math.max(b.loadCount,k):k,marketplace:e.marketplace,userId:e.trunk.userId||void 0,visible:e.view.visible},function(a,o){if(a){if(n&&(b.loaded=!0),e.pagination.start=o.start,e.pagination.total=o.total,t)Array.prototype.push.apply(e.resultList,o.results);else{e.resultList=o.results,C(o.facets.rangeFilters);var s=0;for(var c in o.facets){var l=o.facets[c];for(var d in l){var u=l[d];if(v(u),u.filters.length){s<4&&(u.open=!0);var p=5,f=r.find(e.activeFilters,{name:d});f&&r.each(f.fields,function(e){p=Math.max(p,r.findIndex(u.filters,function(t){return t.val==e})+1)}),u.limit=p,s++}}}e.resultFilters=o.facets}e.getUsers()}i&&i(),e.loading=!1,e.loadingMore=!1,A=!1})},e.resultOrder=function(e){return-1*(e.count+(e.active?.5:0))},e.getUsers=function(){var t=r.groupBy(e.resultList,"userId");for(var i in t)c.getUser(i,function(e,i){e&&r.each(t[i._id],function(e){e.user=i})})},e.onLastDisc=function(){e.resizeRes(function(){"undefined"==typeof b||b.scrolled||(window.scrollTo(0,b.scrollPos),b.scrolled=!0);var t=document.getElementById("results-list");m.getWindowHeight()>m.getFullHeight(t)&&e.pagination.total>e.resultList.length&&e.loadMore()})},e.resizeRes=function(e){var t=document.getElementById("results-container"),i=document.getElementById("results-list"),n=document.getElementById("result-header-static"),a=document.getElementById("result-header-fluid");o(function(){if(angular.element(i).css("width",207*Math.floor(t.clientWidth/207)+"px"),angular.element(a).css("padding-right",n.clientWidth+10+"px"),"function"==typeof e)return e()})},e.isFilterActive=function(t,i){var n=r.find(e.activeFilters,{name:t.prop});return i.active=n&&e.containsStr(n.fields,i.val),i.active},e.isMarketplaceModeActive=function(t){return e.marketplace[t]},e.hasActiveFilters=function(t){var i=r.find(e.activeFilters,{name:t.prop});return i&&i.fields.length},e.clearAllFilters=function(){e.activeFilters=[],e.updateUrl()},e.clearActiveFilters=function(t,i){e.activeFilters=r.filter(e.activeFilters,function(e){return e.name!=t.prop}),i||e.updateUrl()},e.getFacets=function(){s.queryFacet({query:e.searchParam,sort:e.sortParam,filter:e.activeFilters,userId:e.trunk.userId||void 0,marketplace:e.marketplace,visible:e.view.visible,facet:{name:"tag",limit:2,offset:2}},function(e,t){})},e.updateSort=function(){w=!0,e.updateUrl()},e.$watch("fullscreen",function(t){o(function(){e.resizeRes()})}),e.$on("$locationChangeStart",function(){g.setData({loadCount:e.resultList.length,routeTime:new Date,scrollPos:m.getScrollPos()})}),e.handleUrl=function(){var i=s.parseUrlQuery(t.search()),n=!1;e.activeFilters=i.filters,e.searchParam=i.search,i.mode&&(e.marketplace={forSale:"all-market"==i.mode||"sale"==i.mode,forTrade:"all-market"==i.mode||"trade"==i.mode,all:"all"==i.mode}),n=e.marketplace.forSale||e.marketplace.forTrade,i.sort?"new"==i.sort&&!n||"modDate"==i.sort&&!e.isOwnedTrunk||(e.sortParam=i.sort):i.search.length?e.sortParam="rel":n?e.sortParam="new":e.sortParam="createDate","undefined"!=typeof i.visible&&e.isOwnedTrunk&&(e.view.visible=i.visible),S(),e.msOpts&&e.msOpts.active&&e.msOpts.toggleMS(),y||e.performSearch()};var z=function(){e.$watch(function(){return t.url()},function(i){var i=t.url();if(i&&/^\/(t\/|explore)/.test(i)){if(g.isNavBack()){var n=g.getPageData();n&&(b=n)}e.handleUrl()}})};e.toggleFilter=function(t,i){var n=r.find(e.activeFilters,{name:t.prop});n?e.containsStr(n.fields,i.val)?n.fields=r.without(n.fields,String(i.val)):n.fields.push(i.val):e.activeFilters.push({name:t.prop,text:t.text,fields:[i.val]}),e.activeFilters=r.filter(e.activeFilters,function(e){return e.fields.length>0}),e.updateUrl()},e.toggleMarketplaceMode=function(t){switch(t){case"forSale":e.marketplace.forSale&&!e.marketplace.forTrade?e.marketplace.all=!0:e.marketplace.all=!1;break;case"forTrade":e.marketplace.forTrade&&!e.marketplace.forSale?e.marketplace.all=!0:e.marketplace.all=!1;break;case"all":if(e.marketplace.all)return;e.marketplace.forTrade=!1,e.marketplace.forSale=!1}e.marketplace[t]=!e.marketplace[t],e.updateUrl()},angular.element(n).bind("resize",e.resizeRes),e.$on("$destroy",function(){angular.element(n).unbind("resize",e.resizeRes)}),i.username?c.getUserByUsername(i.username,function(t,i){return t?(e.trunk.userId=i._id,e.trunk.user=i,e.statusHome="t/"+i.username,e.resizeRes(),e.isOwnedTrunk&&l.getAccountMarket(function(t,i){return t?(e.marketData=i,void(e.marketData.accountName=f.getAccountName(e.curUser.accountType))):u.setRedirect("explore")}),y=!1,void z()):u.setRedirect("explore")}):(y=!1,e.statusHome="explore",z()),e.resizeRes()}]).controller("RedirectController",["$scope","$timeout","RedirectService","$location",function(e,t,i,n){t(function(){n.path("/"+i.getRedirectPath()).replace()},1e3)}]).controller("DiscController",["$scope","$location","$routeParams","$timeout","$window","_","RedirectService","CacheService","AccountService","DiscService","MessageService",function(e,t,i,n,a,r,o,s,c,l,d){var u=i.discId;t.search({}),e.breadcrumbs=[],e.bumpReady=!1,e.isSaving=!1,e.loading={disc:!0,privacy:!1},e.tempMarketplace={},e.discAlert={},e.marketAlert={};var p=function(){e.breadcrumbs=[{title:"Trunk",links:[{text:e.user.username,href:"/t/"+e.user.username}]},{title:"Disc",links:[{text:e.disc.brand+" "+e.disc.name}]}],e.userInit=!0},f=function(){c.getAccountMarket(function(t,i){t?e.tempMarketplace.counts=i:e.marketAlert.error={title:i.type,message:i.message,show:!0}})},g=function(t){e.tempMarketplace.forSale=t.marketplace.forSale,e.tempMarketplace.forTrade=t.marketplace.forTrade,f()};e.isDef=function(e){return"undefined"!=typeof e},e.showProfileModal=function(){e.globalModalOpts={type:"dz-profile-modal",show:!0,data:{}}},e.shareDisc=function(){e.globalModalOpts={type:"dz-share-modal",show:!0,data:{disc:e.disc}}},e.deleteDisc=function(){var i=[e.disc];e.globalModalOpts={type:"dz-delete-disc-modal",show:!0,data:{discs:i,onClose:function(i){i&&t.url("/t/"+e.user.username)}}}},e.bumpDisc=function(){l.bumpDisc(e.disc._id,function(t,i){t?(e.disc.marketplace.bumpRemaining=i.bumpRemaining,e.bumpReady=!1):e.marketAlert.error={title:i.type,message:i.message,show:!0}})},e.saveDisc=function(){e.isSaving=!0;var t={_id:e.disc._id,marketplace:{forSale:e.tempMarketplace.forSale,forTrade:e.tempMarketplace.forTrade}};l.editDisc(t,function(t,i){t?(e.disc=i,e.bumpReady=0===i.marketplace.bumpRemaining,g(i),e.marketAlert.success={title:"Success",message:"Marketplace options have been updated successfully.",show:!0,timeout:3e3}):e.marketAlert.error={title:"Error",message:"Unable to update marketplace options.",show:!0},e.isSaving=!1})},e.warnPrivacy=function(){e.isMarket()?e.globalModalOpts={type:"dz-acknowledgement-modal",show:!0,data:{message1:"This disc is currently on the marketplace, and making it private will automatically remove it from the marketplace. Do you wish to proceed?",onClose:function(t){t&&e.togglePrivacy()}}}:e.togglePrivacy()},e.togglePrivacy=function(){e.loading.privacy=!0;var t={_id:e.disc._id,visible:!e.disc.visible};l.editDisc(t,function(t,i){n(function(){t?(e.disc=i,g(i)):e.discAlert.error={title:"Error",message:"Unable to update disc visibility.",show:!0},e.loading.privacy=!1})})},e.initMessage=function(){d.setAttachment(d.TypeDisc,e.disc._id),t.path("/inbox").search("userId",e.user._id)},e.setImage=function(t){e.imageBlock=t},e.isMarket=function(){if("undefined"!=typeof e.disc)return e.disc.marketplace.forSale||e.disc.marketplace.forTrade},e.isMarketInvalid=function(){return!e.disc||!e.tempMarketplace.counts||!e.isMarket()&&0===e.tempMarketplace.counts.marketAvailable||!e.disc.visible||!e.disc.primaryImage},e.isDirty=function(){return e.tempMarketplace.forSale!=e.disc.marketplace.forSale||e.tempMarketplace.forTrade!=e.disc.marketplace.forTrade},e.givePermission=function(){return c.compareTo(e.disc.userId)},s.reloadDisc(u,function(t,i){return t?(e.disc=i,e.imageBlock=r.findWhere(i.imageList,{_id:i.primaryImage}),e.discInit=!0,e.givePermission()?(e.user=c.getAccount(),e.isOwner=!0,g(i),p()):s.getUser(i.userId,function(t,i){return t?(e.user=i,e.publicMode=!0,void p()):e.nav()}),void(e.loading.disc=!1)):o.setRedirect("explore")})}]).controller("DiscTemplateController",["$scope","$window","$location","$routeParams","$timeout","_","AccountService","APIService",function(e,t,i,n,a,r,o,s){if(!o.isLoggedIn()){var c=i.path();return i.path("/login").search("redirect",c)}i.search({}),e.templates=[],e.loading=!1,e.$watch("query",function(t){return"undefined"==typeof t||""==t?e.templates=[]:(e.loading=!0,void s.Get("/templates?q="+t,function(t,i){var n=[];if(t){var a=r.groupBy(i,"textSearch");for(var o in a)n.push({fullName:o,name:a[o][0].name,brand:a[o][0].brand,templates:a[o]})}e.templates=r.sortBy(n,"fullName"),e.loading=!1}))}),e.showVowel=function(){return e.query&&/[aeiou]/i.test(e.query.charAt(0))},e.resizeRes=function(){var e=document.getElementById("results-container"),t=document.getElementById("results-list");a(function(){angular.element(t).css("width",208*Math.floor(e.clientWidth/208)+"px")})},angular.element(t).bind("resize",e.resizeRes),e.$on("$destroy",function(){angular.element(t).unbind("resize",e.resizeRes)}),e.resizeRes()}]).controller("ModifyDiscController",["$compile","$scope","$routeParams","$location","$timeout","_","smoothScroll","$ocLazyLoad","APIService","CacheService","ImageService","AccountService","DiscService","RedirectService",function(e,t,i,n,a,r,o,s,c,l,d,u,p,f){if(!u.isLoggedIn()){var g=n.path();return n.path("/login").search("redirect",g)}var m=i.discId,h=i.templateId,v=document.getElementById("page-top"),b='<div class="image-item-container image-template"><div class="image-item"><div class="image-entity"><img data-dz-thumbnail /></div><div class="image-progress" data-dz-uploadprogress></div><div class="image-overlay"><span class="image-remove" data-dz-remove><i class="fa fa-times fa-lg"></i></span><div class="image-title handle-overflow"><span data-dz-name></span></div><div class="image-size handle-overflow" data-dz-size></div></div></div></div>',y=[];t.editAlert={},t.account=u.getAccount(),t.showGeneralHelp=function(){t.globalModalOpts={type:"dz-info-modal",show:!0,data:{title:"Modify Disc Help - General"},partial:"dzGeneralInfo.html"}},t.showAdvancedHelp=function(){t.globalModalOpts={type:"dz-info-modal",show:!0,data:{title:"Modify Disc Help - Advanced"},partial:"dzAdvancedInfo.html"}},t.clearForm=function(e){t.disc={_id:t.disc._id,visible:!0,tagList:[],imageList:[]},t.discForm.$setPristine(),e||(t.editAlert={})},t.currentTagDrag={accept:function(e,t){return e.itemScope.sortableScope.$id===t.$id}},t.currentImageDrag={accept:function(e,t){return e.itemScope.sortableScope.$id===t.$id}},t.disc={_id:m,visible:!0,tagList:[],imageList:[]},t.settings={discReady:!1,dropzoneReady:!1,dropzoneProcessing:!1};var w=function(e){d.getDataUri(e,function(i){t.discImageCropper.showCropper(e.name,i)})},k=function(e){return e?(y.push(e),void(1==y.length&&w(e))):void(y.length&&w(y[0]))};t.dropzoneConfig={options:{url:"/api/images",method:"POST",thumbnailWidth:100,thumbnailHeight:100,parallelUploads:5,maxFiles:5,paramName:"discImage",previewTemplate:b,acceptedFiles:"image/*",autoProcessQueue:!0,previewsContainer:"#dropzone-previews",clickable:"#add-image",accept:function(i,n){return null!=this.files[5]?this.removeFile(this.files[5]):i.cropped||i.width<200?(a(function(){t.discImageCropper.cropperLoading=!1,t.settings.dropzoneProcessing=!0,i.previewElement.setAttribute("dropzone-preview",""),e(angular.element(i.previewElement))(t)}),n()):(a(function(){t.discImageCropper.cropperLoading=!0}),t.dropzoneConfig.getDropzone().removeFile(i),k(i),n("Processing"))},success:function(e,i){"undefined"!=typeof i._id&&(t.disc.imageList.push(i),1==t.disc.imageList.length&&(t.disc.primaryImage=i._id),t.safeApply()),this.removeFile(e)},queuecomplete:function(){a(function(){t.settings.dropzoneProcessing=!1})}}},t.discImageCropper={onFinish:function(e){t.safeApply(function(){t.discImageCropper.cropperLoading=!1}),e&&t.dropzoneConfig.getDropzone().addFile(e),y.shift(),k()},cropperLoading:!1},t.triggerDropzone=function(){t.dropzoneConfig.getDropzone().progTrigger()},t.removeImage=function(e){var i=t.disc.imageList.splice(e,1)[0];i._id==t.disc.primaryImage&&(t.disc.primaryImage=t.disc.imageList.length?t.disc.imageList[0]._id:void 0)},t.removeTag=function(e){t.disc.tagList.splice(e,1)[0]},t.pushTempTag=function(){t.tempTag&&t.tempTag.length&&!r.contains(t.disc.tagList,t.tempTag)?(t.disc.tagList.push(t.tempTag),t.tempTag=""):t.tempTag=""};var A=function(){var e={duration:300,easing:"easeInQuad"};o(v,e)};t.refreshMarket=function(){t.marketLoading=!0,u.getAccountMarket(function(e,i){e?t.market=i:t.editAlert.error={title:i.type,message:i.message,show:!0},t.marketLoading=!1})},t.submitDisc=function(){if(t.discForm.$invalid){for(var e in t.discForm.$error)angular.forEach(t.discForm.$error[e],function(e){e.$setDirty()});return t.editAlert.error={title:"Invalid Input",message:"Please correct any invalid fields and try again.",show:!0},void A()}return t.disc.visible&&0!==t.disc.imageList.length||!t.disc.marketplace||!t.disc.marketplace.forSale&&!t.disc.marketplace.forTrade?(t.marketError=!1,void(t.disc._id?p.editDisc(t.disc,function(e,i){e?(t.disc=i,t.breadcrumbs.splice(1,1,{title:"Disc",links:[{text:i.brand+" "+i.name+" (#"+m+")",href:"/d/"+m}]}),t.editAlert.success={title:"Success",message:{smartConfig:{text:"<!"+i.brand+" "+i.name+"> has been updated successfully.",links:["/d/"+i._id]}},show:!0},A(),t.discForm.$setPristine(),t.refreshMarket()):(t.editAlert.error={title:"Error",message:"Unable to update disc. "+i.type+": "+i.message,show:!0},A())}):p.createDisc(t.disc,function(e,i){e?(t.editAlert.success={title:"Success",message:{smartConfig:{text:"<!"+i.brand+" "+i.name+"> has been created successfully.",links:["/d/"+i._id]}},show:!0},A(),t.clearForm(!0),t.refreshMarket()):(t.editAlert.error={title:i.type,message:i.message,show:!0},A())}))):void(t.marketError=!0)},"undefined"==typeof Dropzone||"undefined"==typeof EXIF||"undefined"==typeof Cropper?s.load(["https://cdn.rawgit.com/exif-js/exif-js/master/exif.js","/static/src/js-dist/dropzone.min.js"]).then(function(){s.load(["/static/src/js-dist/cropper.min.js",{type:"css",path:"https://cdn.rawgit.com/fengyuanchen/cropperjs/master/dist/cropper.min.css"}]).then(function(){t.settings.dropzoneReady=!0})}):t.settings.dropzoneReady=!0,t.breadcrumbs=[{title:"Trunk",links:[{text:t.account.username,href:"/t/"+t.account.username}]}],"undefined"!=typeof m?l.getDisc(m,function(e,i){return e&&u.compareTo(i.userId)?(t.disc=i,t.isMarket=i.marketplace.forSale||i.marketplace.forTrade,t.breadcrumbs.push({title:"Disc",links:[{text:i.brand+" "+i.name+" (#"+m+")",href:"/d/"+m}]}),t.breadcrumbs.push({links:[{text:"Edit Disc"}]}),void(t.settings.discReady=!0)):f.setRedirect("explore")}):(t.breadcrumbs.push({links:[{text:"Create Disc"}]}),"undefined"!=typeof h?c.Get("/templates/"+h,function(e,i){e&&(t.disc={brand:i.brand,name:i.name,type:i.type,material:i.material,speed:i.speed,glide:i.glide,turn:i.turn,fade:i.fade,visible:!0,tagList:[],imageList:[]},t.editAlert.info={title:"Template Applied",message:"The selected template was applied to the form.",show:!0}),t.settings.discReady=!0}):t.settings.discReady=!0),t.refreshMarket()}]).controller("NewsfeedController",["$scope","$location","DataService",function(e,t,i){}]).controller("DashboardController",["$scope","$location","DataService",function(e,t,i){}]).controller("MessageController",["$scope","$location","$timeout","$q","_","smoothScroll","APIService","AccountService","SocketUtils","PageUtils","CacheService","Random","MessageService","PropService",function(e,t,i,n,a,r,o,s,c,l,d,u,p,f){if(!s.isLoggedIn()){var g=t.path();return t.path("/login").search("redirect",g)}var m,h=angular.element(document.getElementById("message-text-area")),v=document.getElementById("message-list");e.page={threadLimit:10,aThreadLimit:10},e.init=!1,e.account=s.getAccount(),e.messageThreads=[],e.archivedThreads=[],e.activeThread=void 0,e.sendOnEnter=!0,e.messageAlert={},e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Inbox"}]}],e.scrollBottom=function(){if(e.activeThread.state)return void i(function(){v.scrollTop=e.activeThread.state.scrollPos||v.scrollHeight,delete e.activeThread.state});var t=angular.element(v)[0].querySelector(".message-item:last-child"),n={duration:700,easing:"easeInQuad",containerId:"message-list"};i(function(){r(t,n),h[0].focus()})};var b=function(){i(function(){var e=document.getElementById("inbox-area"),t=(document.getElementById("footer-bar"),l.getWindowHeight()),i=l.getTop(e);angular.element(e).css("height",t-i-100+"px")})},y=function(e,t){e.messageCount=t.messageCount,e.currentMessageCount=t.currentMessageCount,e.modifiedDate=t.modifiedDate},w=function(t){var i=a.find(t.users,function(t){return t!=e.account._id});d.getUser(i,function(e,i){e?(t.user=i,t.userInit=!0,i.image&&(t.image=i.image,t.imgInit=!0)):t.removed=!0})},k=function(t,i){o.Get("/threads/"+t,function(t,n){if(t){if(n.active){var r=a.findIndex(e.messageThreads,function(e){return e.threadId==n.threadId});r>-1?y(e.messageThreads[r],n):(n.messages=[],e.messageThreads.push(n),w(n)),r=a.findIndex(e.archivedThreads,function(e){return e.threadId==n.threadId}),r>-1&&e.activeThread==e.archivedThreads[r]&&e.archivedThreads.splice(r,1)}else{var r=a.findIndex(e.archivedThreads,function(e){return e.threadId==n.threadId});r>-1?y(e.archivedThreads[r],n):(n.messages=[],e.archivedThreads.push(n),w(n)),r=a.findIndex(e.messageThreads,function(e){return e.threadId==n.threadId}),r>-1&&e.messageThreads.splice(r,1)}i&&e.activateThread(n)}else e.messageAlert.error={title:n.type,message:"Unable to reload message thread. "+n.message,show:!0}})},A=function(t){a.each(t,function(t){t.messages=[],m&&t.threadId==m&&(e.activeThread=t,e.getMessages(!0)),w(t)})},$=function(t,i){t.currentMessageCount!=t.messageCount&&o.Put("/threads/"+t.threadId,{messageCount:t.currentMessageCount},function(n,a){n?y(t,a):e.messageAlert.error={title:t.type,message:"Unable to update message thread. "+t.message,show:!0},i&&i()})},I=function(e){return A([e])},x=function(t){i(function(){if(e.activeThread&&e.activeThread.threadId==t.threadId&&e.activeThread.active)e.activeThread.messages.push(t),e.activeThread.currentMessageCount++,$(e.activeThread);else{var i=a.findWhere(e.messageThreads,{threadId:t.threadId});"undefined"!=typeof i?(i.messages.length&&i.messages.push(t),i.currentMessageCount++):k(t.threadId)}})},T=function(){return"?count="+f.get("MessageReqSize")+(e.activeThread.refId?"&refId="+e.activeThread.refId:"")};e.toggleSend=function(){e.sendOnEnter=!e.sendOnEnter},e.unarchiveThread=function(){e.activeThread&&o.Put("/threads/"+e.activeThread.threadId,{active:!0},function(i,n){if(i){var r=a.findIndex(e.archivedThreads,function(e){return e._id==n._id});r>-1?(e.archivedThreads.splice(r,1),k(n.threadId,!0)):t.url(t.path())}else e.messageAlert.error={title:n.type,message:"Unable to unarchive message thread. "+n.message,show:!0}})},e.archiveThread=function(){e.activeThread&&o.Delete("/threads/"+e.activeThread.threadId,function(i,n){if(i){var r=a.findIndex(e.messageThreads,function(e){return e._id==n._id});r>-1&&(e.messageThreads.splice(r,1),t.url(t.path()))}else e.messageAlert.error={title:n.type,message:"Unable to archive message thread. "+n.message,show:!0}})},e.getMessageImage=function(t){return t.userId==e.account._id?e.account.image:e.activeThread.image},e.getMessages=function(i){if(e.messageAlert={},"undefined"!=typeof e.activeThread){if(e.activeThread.newThread)return;if(i){if(e.activeThread.messages.length)return e.activeThread.state&&(v.scrollTop=e.activeThread.state.scrollPos||v.clientHeight),void $(e.activeThread,p.reloadUnreadCount);e.activeThread.refId=void 0}o.Get("/threads/"+e.activeThread.threadId+"/messages"+T(),function(t,n){t?(e.activeThread.messages.push.apply(e.activeThread.messages,n),e.activeThread.refId=n.length?n[n.length-1]._id:void 0,e.activeThread.messageCount=e.activeThread.currentMessageCount,p.reloadUnreadCount(),i&&(e.activeThread.active?e.activeThread.removed&&(e.messageAlert.info={title:"User Account Removed",message:"The user associated with this thread has deleted his/her account.",show:!0}):e.messageAlert.info={title:"Read-Only",message:"Unarchive this conversation to continue sending messages.",show:!0})):e.messageAlert.error={title:n.type,message:"Unable to get messages. "+n.message,show:!0}})}else t.url(t.path())};var S=function(t){var i=n.defer();if(t.newThread){var r=a.find(t.users,function(t){return t!=e.account._id});o.Post("/threads",{receivingUser:r},function(n,a){n?(I(a),e.messageThreads.splice(e.messageThreads.indexOf(t),1),e.messageThreads.push(a),i.resolve(a)):i.reject(t)})}else i.resolve();return i.promise};e.sendMessage=function(){e.userMessage&&e.userMessage.length&&(e.lockout=!0,S(e.activeThread).then(function(t){var i=t?t:e.activeThread;o.Post("/threads/"+i.threadId+"/messages",{content:e.userMessage},function(i,n){i?(e.activeThread.messages.push(n),k(n.threadId,"undefined"!=typeof t),e.userMessage=""):e.messageAlert.error={title:n.type,message:"Unable to send message. "+n.message,show:!0},e.lockout=!1})},function(t){e.messageAlert.error={title:t.type,message:"Unable to create thread. "+t.message,show:!0},e.lockout=!1}))},e.activateThread=function(i,n){e.activeThread&&(e.activeThread.state={scrollPos:v.scrollTop}),n?t.url(t.path()+"?threadId="+i.threadId+(i.active?"":"&archived=true")).replace():t.url(t.path()+"?threadId="+i.threadId+(i.active?"":"&archived=true"));
},e.loadArchived=function(){o.Get("/threads?archived=true",function(t,i){t?(e.archivedThreads=i,A(e.archivedThreads)):e.messageAlert.error={title:i.type,message:"Unable to load archived message threads. "+i.message,show:!0}})},e.createThread=function(t){var i=a.find(e.messageThreads,function(e){return e.users.indexOf(t)>-1});i?e.activateThread(i,!0):d.getUser(t,function(t,i){if(t){var n={threadId:u.random(9),users:[s.getAccountId(),i._id],newThread:!0,active:!0,threadTag:i.username,modifiedDate:(new Date).toISOString()};I(n),e.messageThreads.push(n),e.activateThread(n,!0)}else e.messageAlert.error={title:i.type,message:"Unable to create thread. "+i.message,show:!0}})};var C=function(){e.$watch(function(){return t.url()},function(i){if(i&&/^\/inbox/.test(i)){if(m=void 0,e.activeThread=void 0,t.search().threadId){if(m=t.search().threadId,t.search().archived)e.archivedThreads.length==[]?e.loadArchived():(e.activeThread=a.findWhere(e.archivedThreads,{threadId:m}),e.getMessages(!0)),e.showArchive=!0;else{if(e.activeThread=a.findWhere(e.messageThreads,{threadId:m}),e.activeThread){var n=e.messageThreads.indexOf(e.activeThread);e.page.threadLimit=Math.max(e.page.threadLimit,n+1),e.showArchive=!1}e.getMessages(!0)}return}if(t.search().userId){var r=p.getAttachments();e.createThread(t.search().userId),r.length&&(e.userMessage="Hi! I am interested in the following disc"+(r.length>1?"(s):":":"),r.forEach(function(i){e.userMessage+="\r\n"+t.host()+"/"+i.type+"/"+i.id}))}}})};e.incThreadLimit=function(t,i){e.page.threadLimit=Math.min(e.messageThreads.length,e.page.threadLimit+10)},e.incAThreadLimit=function(t,i){e.page.aThreadLimit=Math.min(e.archivedThreads.length,e.page.aThreadLimit+10)},e.$watch("init",function(e){e===!0&&C()}),angular.element(window).bind("resize",b),e.$on("$destroy",function(){angular.element(window).unbind("resize",b),c.unregisterForNotification("MessageNotification",x)}),c.registerForNotification("MessageNotification",x),b(),o.Get("/threads",function(t,i){t?(e.messageThreads=i,A(e.messageThreads),e.init=!0):e.messageAlert.error={title:i.type,message:"Unable to load message threads. "+i.message,show:!0}})}]).controller("AccountController",["$scope","$location","$window","$timeout","$compile","$ocLazyLoad","AccountService","APIService","FacebookUtils","ImageService","TempStore",function(e,t,i,n,a,r,o,s,c,l,d){if(!o.isLoggedIn()){var u=t.path();return t.path("/login").search("redirect",u)}t.search({}),e.page={active:"account"},e.accountAlert={},e.promo={},e.account=o.getAccount(),e.tempAccount={},e.location={},e.notifications={},e.breadcrumbs=[{links:[{text:"My Account"}]}],d.hasKey("seenAccount")?e.skip=!0:d.setTempKey("seenAccount",!0);var p='<div class="image-template"><div class="image-item no-border"><div class="image-entity"><img data-dz-thumbnail /></div><div class="image-progress" data-dz-uploadprogress></div><div class="image-overlay show-always"><div class="image-title handle-overflow"><span data-dz-name></span></div><div class="image-size handle-overflow" data-dz-size></div></div></div></div>',f=function(t){o.putAccountImage(t,function(t,i){t?(e.account=i,e.accountAlert.success={title:"Success",message:"Account profile image updated successfully.",show:!0,timeout:3e3},e.cloneAccount()):e.accountAlert.error={title:"Updated Failed",message:i.type+": "+i.message,show:!0}})};e.activatePromo=function(){e.promo.code&&e.promo.code.length&&(e.promo.activation=void 0,e.promo.loading=!0,o.activatePromo(e.promo.code,function(t,i){e.promo.activation={success:t},t?(e.promo.activation.retPromo=i.promo,e.account=i.account):e.promo.activation.error=i,e.promo.loading=!1}))},e.deleteAccount=function(){e.globalModalOpts={type:"dz-delete-account-modal",show:!0,data:{account:e.account}}},e.dropzoneConfig={options:{url:"/api/images",method:"POST",thumbnailWidth:150,thumbnailHeight:150,parallelUploads:1,maxFiles:1,paramName:"accountImage",previewTemplate:p,acceptedFiles:"image/*",autoProcessQueue:!1,previewsContainer:"#profile-img",clickable:"#profile-trigger",accept:function(t,i){return null!=this.files[1]?this.removeFile(this.files[1]):t.cropped||t.width<200?(n(function(){e.discImageCropper.cropperLoading=!1,e.page.dropzoneImage=!0}),i()):(n(function(){e.discImageCropper.cropperLoading=!0}),e.dropzoneConfig.getDropzone().removeFile(t),l.getDataUri(t,function(i){e.discImageCropper.showCropper(t.name,i)}),i("Processing"))},success:function(t,i){"undefined"!=typeof i._id?f(i):i.error&&(e.accountAlert.error={title:"Upload Failed",message:"Unable to upload profile picture. Please try again. "+i.error.title+": "+i.error.message,show:!0,timeout:3e3}),this.removeFile(t),e.page.dropzoneImage=!1},queuecomplete:function(){n(function(){e.page.dropzoneProcessing=!1})},removedallfiles:function(){e.page.dropzoneImage=!1}}},e.discImageCropper={onFinish:function(t){e.safeApply(function(){e.discImageCropper.cropperLoading=!1}),t&&e.dropzoneConfig.getDropzone().addFile(t)},cropperLoading:!1},e.triggerDropzone=function(){e.dropzoneConfig.getDropzone().processQueue()},e.clearDropzone=function(){e.dropzoneConfig.getDropzone().removeAllFiles()},e.deleteAccountImage=function(){o.deleteAccountImage(function(t,i){t?(e.account=i,e.accountAlert.success={title:"Success",message:"Account profile image updated successfully.",show:!0,timeout:3e3},e.cloneAccount()):e.accountAlert.error={title:"Updated Failed",message:i.type+": "+i.message,show:!0}})},e.getJoinDays=function(){return Math.round(Math.abs((new Date(e.account.dateJoined).getTime()-(new Date).getTime())/864e5))},e.countVerifications=function(){var t=0;return e.account.fbId&&t++,e.account.pdgaNumber&&t++,t},e.updateAccount=function(){o.putAccount(e.tempAccount,function(t,i){t?(e.account=i,e.accountAlert.success={title:"Success",message:"Account updated successfully.",show:!0,timeout:3e3},e.cloneAccount()):e.accountAlert.error={title:"Updated Failed",message:i.type+": "+i.message,show:!0}})},e.doFbLink=function(){c.link(function(t,i){t?(e.account=i,e.accountAlert.success={title:"Success",message:"Facebook linked successfully.",show:!0,timeout:3e3}):e.accountAlert.error={title:"Link Failed",message:"Unable to link to Facebook account. "+i.type+": "+i.message,show:!0}})};var g=function(){c.unlink(function(t,i){t?(e.account=i,e.accountAlert.success={title:"Success",message:"Facebook unlinked successfully.",show:!0,timeout:3e3}):e.accountAlert.error={title:"Unlink Failed",message:"Unable to unlink to Facebook account. "+i.type+": "+i.message,show:!0}})};e.warnFbUnlink=function(){e.globalModalOpts={type:"dz-acknowledgement-modal",show:!0,data:{message1:"Do you wish to unlink your Facebook account?",message2:"You will no longer be able to login to disc|zump via Facebook, and your Facebook verification will automatically be disabled if it exists.",onClose:function(e){e&&g()}}}},e.doDelete=function(){o.doAccountDelete(function(e,t){})},e.locSelected=function(t){e.location.curLocation=t.address,e.tempAccount.geoLat=t.latitude,e.tempAccount.geoLng=t.longitude},e.cloneAccount=function(){e.location.search="",e.location.curLocation=e.account.longLocation,e.tempAccount={firstName:e.account.firstName,lastName:e.account.lastName,bio:e.account.bio,geoLat:void 0,geoLng:void 0}},e.cloneAccount(),e.initDropzone=function(){"undefined"==typeof Dropzone||"undefined"==typeof EXIF||"undefined"==typeof Cropper?r.load(["https://cdn.rawgit.com/exif-js/exif-js/master/exif.js","/static/src/js-dist/dropzone.min.js"]).then(function(){r.load(["/static/src/js-dist/cropper.min.js",{type:"css",path:"https://cdn.rawgit.com/fengyuanchen/cropperjs/master/dist/cropper.min.css"}]).then(function(){e.page.dropzoneReady=!0})}):e.page.dropzoneReady=!0},e.getNotifications=function(t){e.page.notificationReady&&!t||(e.page.notificationReady=!1,o.getNotifications(function(t,i){t?e.notifications=i:e.accountAlert.error={title:"Notification Load Failed",message:"Unable to load notifications. "+i.type+": "+i.message,show:!0},e.page.notificationReady=!0}))},e.setNotifications=function(t){e.page.notificationReady=!1,o.putNotifications(e.notifications,function(t,i){t?(e.notifications=i,e.accountAlert.success={title:"Update Successful",message:"Notification settings have been updated successfully.",show:!0,timeout:3e3}):e.accountAlert.error={title:"Update Failed",message:"Unable to save notifications settings. "+i.type+": "+i.message,show:!0},e.page.notificationReady=!0})},e.$watch("page.active",function(t){switch(t){case"profile-pic":return e.initDropzone();case"notification":return e.getNotifications()}}),e.updateTarget=function(i){e.page.active=i,t.url(t.path()+"#"+i)},e.$watch(function(){return location.hash},function(t){var i=t.replace("#","");["account","profile-pic","membership","notification"].indexOf(i)>-1&&(e.skip=!0,e.page.active=i)}),s.Get("/account/count",function(t,i){t&&(e.count=i.count,e.page.ready=!0)})}]).controller("AccountChangeSelController",["$scope","$location","$window","AccountService","APIService","MembershipService","TempStore",function(e,t,i,n,a,r,o){if(!n.isLoggedIn()){var s=t.path();return t.path("/login").search("redirect",s)}t.search({}),e.account=n.getAccount(),e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Membership",href:"/account/membership"}]}],e.selUpgrade=function(e){t.path("/account/membership/process").search("key",o.setTemp(e))},e.getAccountType=function(e){return r.getAccountName(e)},e.getAccountCost=function(e){return r.getAccountCost(e)}}]).controller("AccountAdjustController",["$scope","$location","$window","$timeout","smoothScroll","AccountService","APIService","MembershipService","TempStore",function(e,t,i,n,a,r,o,s,c){if(!r.isLoggedIn()){var l=t.path();return t.path("/login").search("redirect",l)}t.search({}),e.account=r.getAccount(),e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Membership",href:"/account/membership"}]}],e.billing={},e.paypalConfig={},e.upgradeAlert={},e.form={showBilling:!0},e.showPayment=function(){e.upgradeAlert={},e.paypalLoading=!0,s.createHostedPageAdj(e.billing,function(t,i){t?(e.request=i.request,e.paypalConfig.params={src:"https://payflowlink.paypal.com?SECURETOKENID="+i.hostedPage.secureTokenId+"&SECURETOKEN="+i.hostedPage.secureToken,width:"490",height:"380",border:"0",frameborder:"0",scrolling:"no",allowtransparency:"true"},e.paypalConfig.create=!0,e.form={showPayment:!0},n(function(){var e=document.getElementById("payment-container"),t={duration:200,easing:"easeInQuad",offset:50};a(e,t)})):e.upgradeAlert.error={title:i.type,message:i.message,show:!0},e.paypalLoading=!1})}}]).controller("AccountChangeController",["$scope","$location","$window","$timeout","smoothScroll","AccountService","APIService","MembershipService","TempStore",function(e,t,i,n,a,r,o,s,c){if(!r.isLoggedIn()){var l=t.path();return t.path("/login").search("redirect",l)}return e.account=r.getAccount(),e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Membership",href:"/account/membership"}]}],e.form={showConfirm:!0},e.confirm={opAct:!1,paymentMethod:e.account.profile.exists?"useExisting":"createNew"},e.promo={},e.billing={},e.paypalConfig={},e.upgradeAlert={},e.type=c.getTemp(t.search().key),"undefined"==typeof e.type?t.path("/account/membership").replace():(e.accountMethod=s.getChangeType(e.account.profile.type,e.type),e.hasPromoValue=function(e){return e&&e.promo&&(e.promo.config.alternateCost||e.promo.config.promoMonthsBefore)},e.getPromoValue=function(e){if(!e)return 0;if(!e.promo)return e.immediateCharge||0;var t=e.promo.config;return t.promoMonthsBefore?0:t.alternateCost?t.alternateCost:e.immediateCharge||0},e.navBack=function(){e.form.showConfirm||(e.form.showBilling&&e.showConfirm(),e.form.showPayment&&e.showBilling())},e.showConfirm=function(){e.form={showConfirm:!0},n(function(){var e=document.getElementById("confirm-container"),t={duration:200,easing:"easeInQuad",offset:50};a(e,t)})},e.showBilling=function(){e.form={showBilling:!0},n(function(){var e=document.getElementById("billing-container"),t={duration:200,easing:"easeInQuad",offset:50};a(e,t)})},e.showPayment=function(){e.upgradeAlert={},e.paypalLoading=!0,s.createHostedPage(e.type,e.billing,e.promo.code,function(t,i){if(t){e.request=i.request,e.paypalConfig.params={src:"https://payflowlink.paypal.com?SECURETOKENID="+i.hostedPage.secureTokenId+"&SECURETOKEN="+i.hostedPage.secureToken,width:"490",height:"380",border:"0",frameborder:"0",scrolling:"no",allowtransparency:"true"},e.paypalConfig.create=!0,e.form={showPayment:!0};var n=document.getElementById("payment-container"),r={duration:200,easing:"easeInQuad",offset:50};a(n,r)}else e.upgradeAlert.error={title:i.type,message:i.message,show:!0};e.paypalLoading=!1})},e.confirmChange=function(){"upgrade-profile"==e.accountMethod||"downgrade-profile"==e.accountMethod?(e.confirmLoading=!0,s.modifyExisting(e.type,e.promo.code,function(i,n){i?t.url("/account/membership/result?req="+n.req):t.url("/account/membership/result?err_type="+n.type+"&err_msg="+n.message),e.confirmLoading=!1})):"clear-profile"==e.accountMethod?(e.confirmLoading=!0,s.clearExisting(function(i,n){i?t.url("/account/membership/result?req="+n.req):t.url("/account/membership/result?err_type="+n.type+"&err_msg="+n.message),e.confirmLoading=!1})):"no-profile"==e.accountMethod&&e.account.profile.exists&&(e.confirmLoading=!0,s.reactivate(e.type,e.promo.code,function(i,n){i?t.url("/account/membership/result?req="+n.req):t.url("/account/membership/result?err_type="+n.type+"&err_msg="+n.message),e.confirmLoading=!1}))},"undefined"==typeof e.accountMethod?t.path("/account/change").replace():(e.getAccountType=function(e){return s.getAccountName(e)},void(e.getAccountCost=function(e){return s.getAccountCost(e)})))}]).controller("AccountChangeResultController",["$scope","$location","$window","$timeout","AccountService","APIService","MembershipService","TempStore",function(e,t,i,n,a,r,o,s){if(!a.isLoggedIn()){var c=t.path();return t.path("/login").search("redirect",c)}e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Membership",href:"/account/membership"}]}],e.loading=!0,e.error={message:t.search().err_msg,type:t.search().err_type},e.getAccountType=function(e){return o.getAccountName(e)},e.getAccountCost=function(e){return o.getAccountCost(e)},a.getAccount(function(i,n){return i?(e.account=n,e.accountType=n.profile?n.profile.type:n.accountType,e.pending=e.accountType!=n.accountType,t.search().req?r.GetExt("/membership","/request/"+t.search().req,function(t,i){t?(e.request=i,i.error&&(e.error=i.error)):e.error=i,e.loading=!1}):e.loading=!1,void 0):t.path("/account/change").replace()})}]).controller("VerificationsController",["$scope","$location","AccountService","APIService","VerificationService",function(e,t,i,n,a){if(!i.isLoggedIn()){var r=t.path();return t.path("/login").search("redirect",r)}t.search({}),e.account=i.getAccount(),e.pdga={toggle:!0,alert:{}},e.fb={toggle:!0,alert:{},active:"undefined"!=typeof e.account.fbId},e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Verifications"}]}],e.$watch("fb.active",function(t){e.fb.pristine=t===("undefined"!=typeof e.account.fbId)}),e.setFBVerification=function(){i.putVerifications({facebook:e.fb.active},function(t,i){if(t){e.account=i;var n=i.fbId?"made public.":"hidden from the public.";e.fb.alert.success={title:"Success",message:"Your Facebook account has been "+n,show:!0}}else e.fb.alert.error={title:i.type,message:i.message,show:!0}})},e.resetPDGA=function(){e.pdga.alert={},e.pdga.loading=!0,i.resetPDGA(function(t,i){t?(e.account=i,e.pdga.alert.success={title:"Success",message:"Your PDGA Number has been reset.",show:!0}):e.pdga.alert.error={title:i.type,message:i.message,show:!0},e.pdga.loading=!1})},e.verifyPDGA=function(){e.pdga.alert={},e.pdga.loading=!0,i.verifyPDGA(e.pdga.username,e.pdga.password,function(t,i){t?(e.account=i,e.pdga.alert.success={title:"Success",message:"Your PDGA Number has been verified as (#"+e.account.pdgaNumber+").",show:!0}):e.pdga.alert.error={title:i.type,message:i.message,show:!0},e.pdga.loading=!1})}}]).controller("LoginController",["$scope","$location","$window","AccountService","APIService","FacebookUtils",function(e,t,i,n,a,r){var o=t.search().redirect;return n.isLoggedIn()?t.path("/account"):(e.loading=!1,e.cred={username:"",password:""},e.loginAlert={},e.doFbLogin=function(){r.login(function(i,n){return i?"undefined"!=typeof o?t.path(o).search({}):t.path("/explore").search({}):void(n&&("Inactive"==n.type&&(n.message={smartConfig:{text:n.message+" To resend a confirmation email, <!click here>.",links:["/confirm"]}}),e.loginAlert.error={title:n.type,message:n.message,show:!0}))})},void(e.doLogin=function(){e.loading=!0,e.loginAlert={},n.doLogin(e.cred.username,e.cred.password,function(i,n){return i?"undefined"!=typeof o?t.path(o).search({}):t.path("/explore").search({}):(e.loading=!1,void(n&&(e.loginAlert.error={title:n.type,message:n.message,show:!0})))})}))}]).controller("SignupController",["$scope","$location","$window","$timeout","AccountService","APIService","LocalStorage","LocationService","FacebookUtils",function(e,t,i,n,a,r,o,s,c){if(a.isLoggedIn())return t.path("/account").replace();if(!o.itemExists("dz-signup"))return o.addItem("dz-signup",!0),t.path("/about").replace();var l={userLength:/^.{6,15}$/,userChars:/^[a-zA-Z0-9\_]+$/,pwLength:/^.{6,}$/};e.loading=!1,e.signup={user:{}},e.signupAlert={},e.location={results:[],loading:!1,locSet:!1,geo:{}},e.locSelected=function(t){e.location.curLocation=t.address,e.location.geo={latitude:t.latitude,longitude:t.longitude}},e.getFBAccount=function(){c.getFBAccount(function(t,i){t?r.Post("/validate/facebook",{userID:i.token.userID},function(t,a){t?a._id?e.signupAlert.error={title:"Validation Error",message:"The Facebook account is already associated with another user.",show:!0}:n(function(){e.signup.user.firstName=i.account.first_name,e.signup.form.firstName.$setDirty(),e.signup.user.lastName=i.account.last_name,e.signup.form.lastName.$setDirty(),e.signup.user.email=i.account.email,e.signup.form.email.$setDirty(),e.facebook={userID:i.token.userID,accessToken:i.token.accessToken}}):e.signupAlert.error={title:"Validation Error",message:"Unable to validate Facebook credentials. Please try again.",show:!0}}):console.log("no success")})},e.clearForm=function(){e.signupAlert={},e.location={results:[],loading:!1,locSet:!1,geo:{}},e.facebook=void 0,e.signup.user={},e.signup.form.$setPristine()},e.matchFormat=function(t,i){return!!e.signup[t]&&(!!l[i]&&l[i].test(e.signup[t]))},e.doSignUp=function(){e.loading=!0,e.signupAlert={},r.Post("/users",{username:e.signup.user.username,email:e.signup.user.email,firstName:e.signup.user.firstName,lastName:e.signup.user.lastName,password:e.signup.user.password,geoLat:e.location.geo.latitude,geoLng:e.location.geo.longitude,facebook:e.facebook},function(t,i){e.loading=!1,t?(e.signupAlert.success={title:"Signup Successful",message:"A confirmation email has been sent to "+i.email+".",show:!0},e.signupComplete=!0):e.signupAlert.error={title:i.type,message:i.message,show:!0}})}}]).controller("TrunkLookupController",["$scope","$location","RedirectService","$routeParams","CacheService",function(e,t,i,n,a){t.search({}),a.getUser(n.userId,function(e,t){e?i.setRedirect("t/"+t.username):i.setRedirect()})}]).controller("ConfirmController",["$scope","$location","$timeout","$routeParams","AccountService",function(e,t,i,n,a){return a.isLoggedIn()?t.path("/account").search({}):(t.search({}),e.confirmAlert={},e.loading=!0,e.confirmAlert.error={},void a.doAccountConfirm(n.authorizationId,function(i,n){return i?t.path("/t/"+a.getAccount().username).replace():(e.loading=!1,void(n&&(e.confirmAlert.error={title:n.type,message:n.message,show:!0})))}))}]).controller("DeleteController",["$scope","$location","$timeout","$routeParams","AccountService",function(e,t,i,n,a){if(!a.isLoggedIn()){var r=t.path();return t.path("/login").search("redirect",r)}t.search({}),e.deleteAlert={},e.loading=!0,e.deleteSuccess=!1,e.deleteAlert.error={},a.doAccountDeleteConfirm(n.authorizationId,function(t,i){e.loading=!1,e.deleteSuccess=t,t||(e.deleteAlert.error={title:i.type,message:i.message,show:!0})})}]).controller("RecoverController",["$scope","$location","$timeout","$routeParams","AccountService","APIService",function(e,t,i,n,a,r){return a.isLoggedIn()?t.path("/account").replace():(t.search({}),e.recoverAlert={},e.cred={},e.loading=!1,void(e.doRecover=function(){e.loading=!0,r.Post("/account/recover",{email:e.cred.username},function(t,i){e.loading=!1,t?e.recoverAlert.success={title:"Success",message:"A confirmation email has been sent the above email address with instructions on how to recover your account.",show:!0}:e.recoverAlert.error={title:i.type,message:i.message,show:!0}})}))}]).controller("ConfirmInitController",["$scope","$location","$timeout","$routeParams","AccountService","APIService",function(e,t,i,n,a,r){return a.isLoggedIn()?t.path("/account").replace():(t.search({}),e.confirmAlert={},e.cred={},e.loading=!1,void(e.doConfirmInit=function(){e.loading=!0,r.Post("/account/confirm",{email:e.cred.username},function(t,i){e.loading=!1,t?e.confirmAlert.success={title:"Success",message:"A confirmation email has been sent the above email address with instructions on how to activate your account.",show:!0}:e.confirmAlert.error={title:i.type,message:i.message,show:!0}})}))}]).controller("UnsubscribeController",["$scope","$location","$timeout","$routeParams","APIService",function(e,t,i,n,a){e.subscribeAlert={},e.loading=!0,e.success=!1,n.hashId&&n.type?a.Post("/account/unsubscribe",{hashId:n.hashId,notification:n.type},function(t,i){t?(e.loading=!1,e.success=!0):(e.subscribeAlert.error={title:i.type,message:i.message,show:!0},e.loading=!1)}):(e.subscribeAlert.error={title:"Invalid Request",message:"Please try again.",show:!0},e.loading=!1)}]).controller("ResetController",["$scope","$location","$timeout","$routeParams","AccountService","APIService",function(e,t,i,n,a,r){return e.isReset="undefined"==typeof n.authorizationId,t.search({}),!e.isReset&&a.isLoggedIn()||e.isReset&&!a.isLoggedIn()?t.path("/redirect"):(e.isReset&&(e.breadcrumbs=[{links:[{text:"My Account",href:"/account"}]},{links:[{text:"Reset Password"}]}]),e.resetAlert={},e.cred={},e.loading=!1,e.validating=!0,e.isValid=!1,e.matchLen=function(e){return e&&/^.{6,}$/.test(e)},e.doReset=function(){e.resetAlert={},e.isReset?r.Post("/account/reset",{currentPw:e.cred.cpassword,newPw:e.cred.password},function(t,i){t?(e.cred={},e.resetAlert.success={title:"Password Reset",message:"Your password has been reset successfully.",show:!0}):e.resetAlert.error={title:i.type,message:i.message,show:!0}}):r.Post("/account/recover/"+n.authorizationId,{password:e.cred.password},function(t,i){t?(e.cred={},e.resetAlert.success={title:"Password Reset",message:"Your password has been reset successfully. Please login to continue.",show:!0}):e.resetAlert.error={title:i.type,message:i.message,show:!0}})},void(e.isReset?(e.validating=!1,e.isValid=!0):r.Get("/account/recover/"+n.authorizationId,function(t,i){return e.validating=!1,t?void(e.isValid=!0):e.resetAlert.error={title:i.type,message:i.message,show:!0}})))}]).controller("AboutController",["$scope","$location","$compile","$timeout","AccountService","MembershipService",function(e,t,i,n,a,r){e.account=a.getAccount(),t.search({}),e.hiwImage="/static/img/anim/upload.mp4",e.getAccountType=function(e){return r.getAccountName(e)},e.getAccountCost=function(e){return r.getAccountCost(e)}}]).controller("FAQController",["$scope","$location","$timeout","smoothScroll","PageUtils",function(e,t,i,n,a){var r=function(t){var i=document.getElementById(t);i&&(e.activeTarget=t,(a.getTop(i)<a.getScrollPos()||a.getFullHeight(i)>a.getScrollPos()+a.getWindowHeight())&&n(i,{duration:300,easing:"easeInQuad",offset:60}))};e.updateUrl=function(e){location.hash==="#"+e?r("faq-"+e):t.url(t.path()+"#"+e)},e.$watch(function(){return location.hash},function(e){"undefined"!==e&&r("faq-"+e.replace("#",""))})}]).controller("LogoutController",["$location","$timeout","AccountService",function(e,t,i){var n=e.search();return i.isLoggedIn()?void t(function(){i.doLogout(function(){n.redirectURI?e.path("/"+n.redirectURI).replace():e.path("/login").replace()})},500):e.path("/login").replace()}]);